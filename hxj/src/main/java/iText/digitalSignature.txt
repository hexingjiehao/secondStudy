1.å­¦ä¹ digitalSignatureçŸ¥è¯†ç‚¹ï¼š
    1.å‚è€ƒä¹¦ç±ï¼šã€ŠDigital Signatures for PDF documentsã€‹
        è‡ªå·±çš„ç†è§£ï¼šæ„Ÿè§‰åŠ å¯†ç®—æ³•æœ¬è´¨ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªæ˜ å°„å…³ç³»è¡¨ã€‚æ¯”å¦‚æŸæŸåŠ å¯†ç®—æ³•ï¼šæ•°æ®'a',ç»è¿‡åŠ å¯†ç®—æ³•ï¼Œå¾—åˆ°å€¼'123'ã€‚äºæ˜¯è¯¥ç®—æ³•å»ºç«‹èµ·äº†ä¸€ä¸ªæ˜ å°„å…³ç³»'a'='123'ã€‚
                  æœ‰çš„åŠ å¯†ç®—æ³•ï¼Œä½¿ç”¨ç§˜é’¥aå¯ä»¥ä»keyè®¡ç®—å‡ºvalueï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ä»valueè®¡ç®—å‡ºkeyã€‚è¿™æ˜¯å¯¹ç§°åŠ å¯†ç®—æ³•ã€‚å±äº3ç»´å±‚é¢çš„åŠ å¯†è§£å¯†a-key-value
                  æœ‰çš„åŠ å¯†ç®—æ³•ï¼Œä½¿ç”¨ç§˜é’¥aå¯ä»¥ä»keyè®¡ç®—valueï¼Œä½†æ˜¯ä¸èƒ½ä»valueè®¡ç®—å‡ºkey,éœ€è¦ä¸€ä¸ªè¾…åŠ©ç§˜é’¥bï¼Œå¸®å‡ºvalueåœ¨åŒæ ·çš„ç®—æ³•ä¸­è®¡ç®—å‡ºkeyã€‚è¿™æ˜¯ä¸€ç§äº¤å‰æ˜ å°„è¡¨ã€‚ä¹Ÿå°±æ˜¯éå¯¹ç§°åŠ å¯†ç®—æ³•
                  æ¯”å¦‚ï¼šå®é™…ä¸ŠåŠ å¯†å’Œè§£å¯†æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€ä¸ªè°ƒç”¨åŒä¸€ä¸ªå‡½æ•°çš„è¿‡ç¨‹è€Œå·²ï¼Œå…¬é’¥å’Œç§é’¥çš„æœ¬è´¨éƒ½æ˜¯ä¸€ä¸ªkeyè€Œå·²ï¼Œç”¨äºè°ƒç”¨å‡½æ•°çš„å‚æ•°ä¼ é€’
                        å…¬é’¥    å¾…ç®—æ³•å¤„ç†çš„å†…å®¹(åŠ å¯†)   å¤„ç†åçš„å†…å®¹    ç§é’¥   å¤„ç†åçš„å†…å®¹(è§£å¯†)
                        "a"          "5"                 "A"        "b"       "5"
                        "b"          "A"                 "5"        "a"       "A"
                        "a"          "A"                 "a0"       "b"       "6"
                        "b"          "5"                 "B"        "a"       "7"
                  å®é™…ä¸Šï¼šéå¯¹ç§°åŠ å¯†ç®—æ³•çš„å…¬é’¥å’Œç§é’¥ä¹Ÿæ˜¯ä¸€ä¸ªæ˜ å°„å…³ç³»è¡¨ã€‚ç”±æƒå¨è®¤è¯æœºæ„(CA)ç®¡ç†ã€‚ä¸Šè¿°ä¾‹å­ä¸­çš„"a"-"b"åº”è¯¥å°±æ˜¯å…¶ä¸­ä¸€ç§
                  çŒœæƒ³ï¼šæ—¢ç„¶åŠ å¯†ç®—æ³•çš„æœ¬è´¨æ˜¯è¦å»ºè®®ä¸€ç§æ˜ å°„å…³ç³»ã€‚å¦‚æœèƒ½å¤Ÿå»ºç«‹ä¸€ç§4ç»´å…³ç³»å›¾a-key-b-valueã€‚é‚£ä¹ˆè¯¥åŠ å¯†ç®—æ³•å°±ä¸éœ€è¦äº†ã€‚ç›´æ¥ä»4ç»´å…³ç³»å›¾ä¸­æŸ¥è¯¢ã€‚ç†è®ºä¸Š4ç»´ä¸Šæ¯ä¸ªå˜é‡éƒ½æ˜¯æ— ç©·çš„ã€‚
                       ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥å°†å¸¸ç”¨çš„å–å€¼å–å‡ºï¼Œåšä¸€ä¸ªæ¶µç›–å¤§èŒƒå›´çš„æ˜ å°„è¡¨ï¼Œåªè¦çŸ¥é“åŠ å¯†ç®—æ³•å’Œå…¬é’¥ï¼Œå°±èƒ½è§£å¯†å¤§éƒ¨åˆ†å†…å®¹äº†ã€‚ä½¿ç”¨æš´åŠ›ç ´è§£æ€æƒ³+æ—¶é—´çš„ç§¯ç´¯ï¼Œèƒ½å¤Ÿå®ŒæˆæŸä¸ªç®—æ³•å¤§éƒ¨åˆ†çš„4ç»´å…³ç³»å›¾ã€‚

        ä»‹ç»ï¼š
            é—®ï¼šä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦pdfå’Œæ•°å­—ç­¾å
            ç­”ï¼šPDFè¿‡å»çš„ä¸»è¦åŸç†æ˜¯ä»¥ä¸€ç§å¯é çš„æ–¹å¼æŸ¥çœ‹å’Œæ‰“å°æ–‡æ¡£ã€‚
               äººä»¬å¯¹ä¾¿æºå¼æ–‡æ¡£æ ¼å¼çš„éœ€æ±‚ï¼Œå®ƒåº”è¯¥èƒ½å¤Ÿæä¾›åœ¨å±å¹•å’Œæ‰“å°æœºç›¸åŒçš„è¾“å‡ºç»“æœã€‚è€Œä¸”ç›¸å¯¹äºå…¶ä»–æ–‡æ¡£æ ¼å¼æœ‰ä¼˜åŠ¿ï¼šç”µå­ç­¾å
               ä¸ºäº†ä¿è¯æœ‰æ³•å¾‹ä»·å€¼æ–‡ä»¶çš„çœŸå®æ€§å’Œå®Œæ•´æ€§ä»ï¼Œä»è€Œä»£æ›¿ç™½çº¸é»‘å­—çš„æ•ˆæœã€‚PDFï¼Œå…¨åå«åšå¯ç§»æ¤æ–‡æ¡£æ ¼å¼ï¼Œäºæ˜¯è¢«ä½¿ç”¨åšç”µå­ç­¾åçš„è½½ä½“ã€‚

        ç¬¬1ç« ï¼šç†è§£æ•°å­—ç­¾åçš„æ¦‚å¿µğŸŒ¿ğŸŒ¿ğŸŒ¿ğŸŒ¿ğŸŒ¿
            - ä¸€ä¸ªç®€å•çš„PDFç¤ºä¾‹
                é—®ï¼šå¦‚ä½•ä¼ªé€ pdfå†…å®¹ï¼Ÿä¸€ä¸ªæ•°å­—ç­¾åè¿‡çš„pdfæ–‡æ¡£ï¼Ÿæ£€æŸ¥æ•°å­—ç­¾åçš„è¯­æ³•ï¼Ÿä½¿ç­¾åæ— æ•ˆï¼Ÿ
                ç­”ï¼šä¸€ä¸ªpdfæ–‡ä»¶å¯ä»¥æœ‰æŒ‡å®šçš„è¯­æ³•ç¼–å†™å®Œæˆ%PDF ... %%EOFã€‚æ‰€ä»¥ï¼Œèƒ½å¤Ÿä¿®æ”¹pdfæºæ–‡ä»¶çš„å†…å®¹ï¼Œä»è€Œä¼ªé€ pdfæ–‡ä»¶ã€‚ä¸ºäº†ç¡®ä¿pdfæ–‡æ¡£ä¸è¢«ä¼ªé€ ï¼Œéœ€è¦è¿›è¡Œä¿æŠ¤
                    æ•°å­—ç­¾åçš„æ­£ç¡®æ€§å¯ä»¥ä¿è¯pdfæ²¡æœ‰è¢«ä¼ªé€ ä¿®æ”¹ã€‚
                    ç­¾åæ˜¯åœ¨æ•´ä¸ªæºæ–‡ä»¶çš„byteå†…å®¹è¿›è¡Œä»£ç æ··æ·†(hashåŠ å¯†ï¼Œç‰µä¸€å‘è€ŒåŠ¨å…¨èº«)ï¼Œå½¢æˆæ–°çš„æ–‡ä»¶ï¼Œç­¾åæ˜¯çœ‹ä¸è§çš„ï¼Œæœ€å¤§ç¨‹åº¦ä¸Šä¿è¯pdfå®Œæ•´ã€‚
                    å½“å¯¹ç­¾ååçš„pdfæ–‡æ¡£è¿›è¡Œå†…å®¹ä¿®æ”¹ï¼Œadobe readeråœ¨è§£æpdfæ–‡ä»¶æ—¶ï¼Œå‘ç°ç­¾åç»“æ„é”™è¯¯ï¼ŒæŠ¥é”™å†…å®¹è¢«ä¿®æ”¹ã€‚
            - åˆ›å»ºæ¶ˆæ¯æ‘˜è¦
                é—®ï¼šå¦‚ä½•æ£€æŸ¥å¯†ç ï¼Ÿä»€ä¹ˆæ˜¯æ‘˜è¦ç®—æ³•? Java SDKçš„é»˜è®¤MessageDigestå®ç°ï¼Ÿ Bouncy Castle(è½»é‡çº§å¯†ç æœ¯åŒ…) ï¼Ÿ
                ç­”ï¼šåœ¨æ•°æ®åº“ä¸­å­˜å‚¨å¯†ç æ‘˜è¦ï¼Œè€Œä¸æ˜¯å®é™…å¯†ç ã€‚ä¸¾ä¾‹ï¼š
                                         public class DigestDefault {
                                            protected byte[] digest;
                                            protected MessageDigest md;

                                            protected DigestDefault(String password, String algorithm, String provider) throws GeneralSecurityException {
                                                if (provider == null)
                                                    md = MessageDigest.getInstance(algorithm);
                                                else
                                                    md = MessageDigest.getInstance(algorithm, provider);
                                                digest = md.digest(password.getBytes());
                                            }

                                            public static DigestDefault getInstance(String password, String algorithm) throws GeneralSecurityException {
                                                return new DigestDefault(password, algorithm, null);
                                            }
                                            public int getDigestSize() {
                                                return digest.length;
                                            }
                                            public String getDigestAsHexString() {
                                                return new BigInteger(1, digest).toString(16);
                                            }
                                            public boolean checkPassword(String password) {
                                                return Arrays.equals(digest, md.digest(password.getBytes()));
                                            }
                                            public static void showTest(String algorithm) {
                                                try {
                                                    DigestDefault app = getInstance("password", algorithm);
                                                    System.out.println("Digest using " + algorithm + ": "+ app.getDigestSize());
                                                    System.out.println("Digest: " + app.getDigestAsHexString());
                                                    System.out.println("Is the password 'password'? "+ app.checkPassword("password"));
                                                    System.out.println("Is the password 'secret'? "+ app.checkPassword("secret"));
                                                } catch (NoSuchAlgorithmException e) {
                                                    System.out.println(e.getMessage());
                                                }
                                            }
                                         }
                    åˆ›å»ºæ‘˜è¦æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨hashåŠ å¯†ç®—æ³•å°†ä»»æ„æ•°æ®å—è½¬åŒ–ä¸ºå›ºå®šå¤§å°çš„å­—ç¬¦ä¸²ï¼Œæ•°æ®å—åˆå«æ¶ˆæ¯ï¼Œå“ˆå¸Œå€¼åˆå«åšæ¶ˆæ¯æ‘˜è¦ã€‚
                        ä»¥å‰æ•°æ®å—æ˜¯ã€Šå¯†ç passwordã€‹ï¼Œç°åœ¨å¯¹äºpdfæ–‡æ¡£è€Œè¨€ï¼Œpdfæ–‡ä»¶çš„ç‰¹å®šèŒƒå›´çš„byteæ•°æ®å¯¹è±¡æ˜¯æ•°æ®å—ã€‚æ‰€ä»¥ï¼Œä»»æ„å¯¹pdfçš„ä¿®æ”¹ï¼Œéƒ½å°†å¯¼è‡´hashå€¼ä¸ä¸€è‡´ã€‚
                        è¿™æ˜¯ä¸€ä¸ªå•å‘ç®—æ³•ã€‚èƒ½ä»å¯†ç è®¡ç®—å‡ºæ¶ˆæ¯æ‘˜è¦ï¼Œä½†æ˜¯ä¸èƒ½ä»æ¶ˆæ¯æ‘˜è¦è®¡ç®—å‡ºå¯†ç ã€‚éƒ¨åˆ†è€æ—§hashç®—æ³•æœ‰æ¼æ´ï¼Œç›®å‰éƒ½è‡³å°‘æ˜¯salt hashå¹¶ä¸”å¤šæ¬¡è¿­ä»£
                        å¸¸ç”¨çš„åŠ å¯†hashç®—æ³•ï¼šMD5(128bitä½ï¼Œæœ‰2^128ç§hashå€¼ï¼Œå¹¿æ³›ä½¿ç”¨ä½†ä¸å¤ªå®‰å…¨)ï¼ŒSHA(æ ‡å‡†å®‰å…¨ï¼Œsha-1æœ‰60bitä½,æœ‰2^160ç§hashå€¼ï¼Œä¾æ—§å­˜åœ¨bugï¼Œå¤šç§sha-2ç®—æ³•æ˜¯å®‰å…¨çš„)ï¼ŒRIPEMDï¼ˆæœ‰128bitï¼Œ160bit,256bitï¼‰ç­‰
                    javaä¸­çš„æ¶ˆæ¯æ‘˜è¦çš„åŠ å¯†ç®—æ³•å®ç°ï¼š MD5ï¼ŒSHAæ—ã€‚RIPEMDä¸åˆé€‚
                    bouncy Castleæ˜¯ä¸€ä¸ªç”¨äºå¯†ç å­¦çš„APIé›†åˆã€‚æ ¸å¿ƒæ˜¯BouncyCastleProviderã€‚ä¸¾ä¾‹ï¼š
                                        public class DigestBC extends DigestDefault {
                                            public static final BouncyCastleProvider PROVIDER = new BouncyCastleProvider();
                                            static {
                                                //æä¾›ä¸°å¯Œçš„åŠ å¯†ç®—æ³•ï¼Œæ¯”å¦‚æä¾›äº†RIPEMDåŠ å¯†ç®—æ³•
                                                Security.addProvider(PROVIDER);
                                            }
                                            protected DigestBC(String password, String algorithm) throws GeneralSecurityException {
                                                super(password, algorithm, PROVIDER.getName());
                                            }
                                            public static DigestBC getInstance(String password, String algorithm, String provider)throws NoSuchAlgorithmException, NoSuchProviderException {
                                                return new DigestBC(password, algorithm);
                                            }
                                        }
                        æ³¨æ„ï¼šå¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œå¯ä»¥é€šè¿‡åå¤ä¿®æ”¹æ–‡æ¡£ï¼Œè¿›è€Œæ¨æµ‹åŠ å¯†ç®—æ³•ï¼Œä»è€Œæ›´å®¹æ˜“ä¼ªé€ å†…å®¹ã€‚å› æ­¤éœ€è¦éå¯¹ç§°ç®—æ³•è¿›è¡ŒåŠ å¯†ã€‚
            - ä½¿ç”¨å…¬é’¥åŠ å¯†å¯¹æ¶ˆæ¯è¿›è¡ŒåŠ å¯†
                é—®ï¼šåˆ›å»ºå¯†é’¥å­˜å‚¨ï¼ŸåŠ å¯†å’Œè§£å¯†æ¶ˆæ¯ï¼Ÿæ£€æŸ¥æˆ‘ä»¬çš„è‡ªç­¾åè¯ä¹¦ï¼Ÿä½¿ç”¨å…¬é’¥ç®—æ³•è¿›è¡Œèº«ä»½éªŒè¯å’Œä¸å¯å¦è®¤æ€§ï¼Ÿ
                ç­”ï¼šå¯¹ç§°åŠ å¯†ç®—æ³•ä¸ä»…åŒ…æ‹¬åŠ å¯†å’Œè§£å¯†ä½¿ç”¨ç›¸åŒçš„ç§˜é’¥ï¼ŒåŒæ—¶ä¹ŸåŒ…æ‹¬ç”¨äºåŠ å¯†çš„å¯†é’¥æ´¾ç”Ÿå‡ºç”¨äºè§£å¯†çš„å¯†é’¥ã€‚æœ€å¸¸ç”¨çš„å…¬é’¥åŠ å¯†ç³»ç»Ÿæ˜¯RSAã€‚å®ƒæ˜¯éå¯¹ç§°åŠ å¯†ç®—æ³•ã€‚å¯¹ç§°åŠ å¯†ç®—æ³•æ²¡æœ‰å…¬é’¥å’Œç§é’¥çš„æ¦‚å¿µã€‚
                    å¯ä»¥é€šè¿‡java sdkè‡ªå¸¦çš„keytoolå·¥å…·æ¥åˆ›å»ºç§˜é’¥å¯¹ï¼Œå®ƒåŒ…å«ä¸€ä¸ªç§é’¥å’Œä¸€ä¸ªè¯ä¹¦ï¼Œè¯¥è¯ä¹¦ä¸­åŒ…å«ç”¨æˆ·ä¿¡æ¯å’Œå…¬é’¥ã€‚å‘½ä»¤è¡Œæ“ä½œç¤ºä¾‹ï¼š
                        keytool -genkey -v -keystore myKey.jks -keyalg RSA -keysize 2048 -validity 10000 -alias myAlias
                        è¾“å…¥ä½ çš„ç§˜é’¥å­˜å‚¨åº“å¯†ç ï¼š
                        å†æ¬¡è¾“å…¥ä½ çš„ç§˜é’¥å­˜å‚¨åº“å¯†ç ï¼š
                        ä¾æ¬¡ä½ çš„ç›¸å…³ä¿¡æ¯ï¼šå¤šè¡Œå¤šæ¬¡è¾“å…¥
                        è¾“å…¥ä½ çš„ç§˜é’¥å¯†ç å¯¹äºåˆšæ‰åˆ›å»ºçš„é¡¹ç›®<demo>å¯†ç ï¼ˆå’Œä¸Šé¢çš„å¯†ç ä¸€è‡´ï¼‰ï¼š

                        æ³¨æ„ï¼šç§˜é’¥å­˜å‚¨åº“å¯ä»¥åŒ…å«å¤šä¸ªç§é’¥ï¼Œç§é’¥çš„å¯†ç  ä¸åŒäº å¯†é’¥å­˜å‚¨åº“çš„å¯†ç ã€‚ä¾‹å¦‚ï¼šè¦è·å–ç§é’¥å†…å®¹ï¼Œé¦–å…ˆéœ€è¦è¾“å…¥ç§˜é’¥å­˜å‚¨åº“å¯†ç ï¼Œç„¶åè¾“å…¥æŒ‡å®šç§é’¥çš„å¯†ç ï¼Œæ‰èƒ½è·å–è¯¥ç§é’¥å†…å®¹ã€‚
                             åœ¨macä¸Šç”Ÿæˆçš„ç§˜é’¥ä½ç½®ï¼šcd ï½/.ssh/  id_rsa.pubå°±æ˜¯å…¬é’¥ã€‚
                             githubä¸Šçš„ä»£ç ç®¡ç†ä¹Ÿç”¨åˆ°äº†è¿™ä¸ªåŠ å¯†æœºåˆ¶ã€‚æˆ‘æœ¬æœºçš„è¯ä¹¦è®©githubä¿¡ä»»(æœ¬è´¨æ˜¯æœ¬æœºçš„å…¬é’¥ç»™äº†github)ï¼Œgithubå°±èƒ½å¤Ÿç›´æ¥ç»™æˆ‘å‘ä¿¡æ¯ï¼Œä¸éœ€è¦æ¯æ¬¡éƒ½è¾“å…¥å¯†ç 
                    åŠ å¯†å’Œè§£å¯†æ­¥éª¤çš„æ ¸å¿ƒæ˜¯KeyStoreå’Œkeyç±»ï¼šæ¯”å¦‚ï¼š
                                        public class EncryptDecrypt {
                                            protected KeyStore ks;
                                            public EncryptDecrypt(String keystore, String ks_pass) throws GeneralSecurityException, IOException {
                                                initKeyStore(keystore, ks_pass);
                                            }
                                            public void initKeyStore(String keystore, String ks_pass)throws GeneralSecurityException, IOException {
                                                ks = KeyStore.getInstance(KeyStore.getDefaultType());
                                                ks.load(new FileInputStream(keystore), ks_pass.toCharArray());
                                            }
                                            public X509Certificate getCertificate(String alias)throws KeyStoreException {
                                                return (X509Certificate) ks.getCertificate(alias);
                                            }
                                            public Key getPublicKey(String alias)throws GeneralSecurityException, IOException {
                                                return getCertificate(alias).getPublicKey();
                                            }
                                            public Key getPrivateKey(String alias, String pk_pass) throws GeneralSecurityException, IOException {
                                                return ks.getKey(alias, pk_pass.toCharArray());
                                            }
                                            public byte[] encrypt(Key key, String message)throws GeneralSecurityException {
                                                Cipher cipher = Cipher.getInstance("RSA");
                                                cipher.init(Cipher.ENCRYPT_MODE, key);
                                                byte[] cipherData = cipher.doFinal(message.getBytes());
                                                return cipherData;
                                            }
                                            public String decrypt(Key key, byte[] message) throws GeneralSecurityException {
                                                Cipher cipher = Cipher.getInstance("RSA");
                                                cipher.init(Cipher.DECRYPT_MODE, key);
                                                byte[] cipherData = cipher.doFinal(message);
                                                return new String(cipherData);
                                            }
                                            public static void main(String[] args)throws GeneralSecurityException, IOException {
                                                //é¦–å…ˆå…ˆè¦æ‰§è¡Œä¸€ä¸‹å‘½ä»¤ï¼š
                                                // keytool -genkey -v -keystore myKey.jks -keyalg RSA -keysize 2048 -validity 10000 -alias myAlias
                                                // è¾“å…¥å¯†ç 123456
                                                EncryptDecrypt app =new EncryptDecrypt("/Users/admin/myKey.jks", "123456");
                                                Key publicKey = app.getPublicKey("myAlias");
                                                Key privateKey = app.getPrivateKey("myAlias", "123456");

                                                System.out.println("Let's encrypt 'secret message' with a public key");
                                                byte[] encrypted = app.encrypt(publicKey, "secret message");
                                                System.out.println("Encrypted message: "+ new BigInteger(1, encrypted).toString(16));
                                                System.out.println("Let's decrypt it with the corresponding private key");
                                                String decrypted = app.decrypt(privateKey, encrypted);
                                                System.out.println(decrypted);
                                                System.out.println("You can also encrypt the message with a private key");
                                                encrypted = app.encrypt(privateKey, "secret message");
                                                System.out.println("Encrypted message: "+ new BigInteger(1, encrypted).toString(16));
                                                System.out.println("Now you need the public key to decrypt it");
                                                decrypted = app.decrypt(publicKey, encrypted);
                                                System.out.println(decrypted);
                                            }
                                        }
                    è¯ä¹¦æœ‰æ‹¥æœ‰è€…å’Œå‘è¡Œäººçš„å±æ€§ï¼Œå½“åœ¨æœ¬æœºä½¿ç”¨å‘½ä»¤è¡Œåˆ›å»ºç§˜é’¥æ—¶ï¼Œè¿™ä¸ªè¯ä¹¦å°±æ˜¯è‡ªç­¾åè¯ä¹¦ã€‚é€šè¿‡ä»£ç æŸ¥è¯¢è¯ä¹¦å†…å®¹Certificate.toString()
                    å› ä¸ºæˆ‘ç”¨ç§é’¥åŠ å¯†çš„æ¶ˆæ¯ï¼Œä½¿ç”¨æˆ‘çš„å…¬é’¥èƒ½å¤Ÿè§£å¯†ã€‚å½“åˆ«äººä½¿ç”¨æˆ‘çš„è¯ä¹¦ä¸­çš„å…¬é’¥è§£å¯†æ—¶ï¼Œå®ƒçŸ¥é“è¿™æ˜¯æˆ‘çš„ç§é’¥è¿›è¡Œçš„åŠ å¯†ï¼Œè€Œè¿™ä¸ªç§é’¥åªæœ‰ç§˜é’¥çš„æ‹¥æœ‰è€…æœ‰ï¼Œç¡®å®šäº†æ¶ˆæ¯çš„å‘é€è€…çš„èº«ä»½ã€‚é™¤éæˆ‘çš„ç§é’¥æ³„æ¼äº†
                        å…¬é’¥ç§é’¥æœºåˆ¶è§£å†³äº†æ•°æ®å®Œæ•´æ€§ï¼Œèº«ä»½éªŒè¯å’Œä¸å¯å¦è®¤æ€§ã€‚
                        å½“éœ€è¦åŠ å¯†è§£å¯†å¤§æ•°æ®é‡æ¶ˆæ¯æ—¶ï¼Œè¿™ä¸ç°å®ã€‚æˆ‘ä»¬å¯ä»¥åªå°†æ¶ˆæ¯æ‘˜è¦è¿›è¡ŒåŠ å¯†è§£å¯†ï¼Œå½“æ¶ˆæ¯æ‘˜è¦æ˜¯çœŸå®çš„ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¤å®šæ•´ä¸ªæ¶ˆæ¯æ˜¯çœŸå®çš„ã€‚
                        ä¹Ÿå°±æ˜¯æ•°å­—ç­¾å--åªåŠ å¯†è§£å¯†æ¶ˆæ¯æ‘˜è¦ï¼ˆéƒ½èƒ½å¤Ÿå®Œæ•´è¡¨ç¤ºæ¶ˆæ¯ï¼‰ã€‚ç±»ä¼¼äºäºŒæ¬¡åŠ å¯†æ“ä½œ(åŠ å°‘æ•°æ®é‡ï¼ŒèŠ‚çº¦æ—¶é—´å’ŒCPU)
            - å¯†ç å­¦ç¼©ç•¥è¯­åŠæ ‡å‡†æ¦‚è¿°
                é—®ï¼šé¦–å­—æ¯ç¼©ç•¥è¯ï¼Ÿå…¬é’¥å¯†ç å­¦æ ‡å‡†(PKCS)ï¼ŸPDF ISOæ ‡å‡†ï¼ŸCAdES, XAdESå’ŒPAdESï¼Ÿ
                ç­”ï¼šé¦–å­—æ¯ç¼©ç•¥è¯ï¼š
                        PKI--è¡¨ç¤ºå…¬é’¥åŸºç¡€è®¾æ–½ã€‚å®ƒæ˜¯ä¸€ç»„åˆ›å»ºã€ç®¡ç†ã€åˆ†å‘ã€ä½¿ç”¨ã€å­˜å‚¨å’Œæ’¤é”€æ•°å­—è¯ä¹¦æ‰€éœ€çš„ç¡¬ä»¶ã€è½¯ä»¶ã€äººå‘˜ã€ç­–ç•¥å’Œè¿‡ç¨‹ã€‚
                        ASN.1--è¡¨ç¤ºæŠ½è±¡è¯­æ³•ç¬¦å·ã€‚å®ƒæ˜¯ä¸€ç§æ ‡å‡†çš„ã€çµæ´»çš„ç¬¦å·ï¼Œæè¿°ç”¨äºè¡¨ç¤ºã€ç¼–ç ã€ä¼ è¾“å’Œè§£ç ç”µä¿¡å’Œè®¡ç®—æœºç½‘ç»œæ•°æ®çš„è§„åˆ™å’Œç»“æ„ã€‚
                        BER--è¡¨ç¤ºåŸºæœ¬ç¼–ç è§„åˆ™ã€‚å®ƒä»¬æ˜¯ASN.1æ ‡å‡†è§„å®šçš„åŸå§‹è§„åˆ™ï¼Œç”¨äºå°†æŠ½è±¡ä¿¡æ¯ç¼–ç åˆ°ç‰¹å®šçš„æ•°æ®æµä¸­
                        DER--è¡¨ç¤ºåŒºåˆ†ç¼–ç è§„åˆ™ã€‚DERæ˜¯BERçš„å­é›†ï¼Œæä¾›äº†ä¸€ç§ç¼–ç ASN.1å€¼çš„æ–¹æ³•ã€‚å®ƒæ˜¯ä»X.509å¯¹BERç¼–ç çš„çº¦æŸä¸­å¾—åˆ°çš„ã€‚
                        X.509--X.509æ˜¯å…¬é’¥åŸºç¡€è®¾æ–½(PKI)å’Œæƒé™ç®¡ç†åŸºç¡€è®¾æ–½çš„æ ‡å‡†ã€‚å®ƒæŒ‡å®šäº†å…¬é’¥è¯ä¹¦å’Œè¯ä¹¦æ’¤é”€åˆ—è¡¨çš„æ ‡å‡†æ ¼å¼ã€‚
                        IETF--ä»£è¡¨ä¸€ä¸ªç»„ç»‡ï¼Œå’ŒW3C,ISO,IECä¸€èµ·å¼€å‘å’Œæ¨åŠ¨äº†ç½‘ç»œæ ‡å‡†
                        RFC--ä»£è¡¨å¾æ±‚æ„è§çš„å¤‡å¿˜å½•ã€‚RFCæ˜¯äº’è”ç½‘å·¥ç¨‹ç‰¹åˆ«å·¥ä½œç»„(IETF)å‘å¸ƒçš„ä¸€ä»½å¤‡å¿˜å½•ï¼Œæè¿°äº†é€‚ç”¨äºäº’è”ç½‘å’Œäº’è”ç½‘è¿æ¥ç³»ç»Ÿå·¥ä½œçš„æ–¹æ³•ã€è¡Œä¸ºã€ç ”ç©¶æˆ–åˆ›æ–°ã€‚
                        FIPS--ä»£è¡¨è”é‚¦ä¿¡æ¯å¤„ç†æ ‡å‡†ã€‚è¿™æ˜¯ç¾å›½è”é‚¦æ”¿åºœä¸ºè®¡ç®—æœºç³»ç»Ÿå¼€å‘çš„ä¸€ç§æ ‡å‡†åŒ–ã€‚
                    å…¬é’¥å¯†ç å­¦æ ‡å‡†(PKCS)ï¼šç›®å‰åªè¦ä½¿ç”¨PKCS#7,ä¹Ÿå°±æ˜¯åŠ å¯†æ¶ˆæ¯è¯­æ³•(CMS)
                        PKCS#1: RSAåŠ å¯†æ ‡å‡†
                        PKCS#7:åŠ å¯†æ¶ˆæ¯è¯­æ³•æ ‡å‡†
                        PKCS#11:å¯†ç ä»¤ç‰Œæ¥å£ã€‚å®ƒæ˜¯ä¸€ä¸ªAPIï¼Œå®šä¹‰äº†åŠ å¯†ä»¤ç‰Œçš„é€šç”¨æ¥å£
                        PKCS#12:ä¸ªäººä¿¡æ¯äº¤æ¢è¯­æ³•æ ‡å‡†ã€‚è¯¥æ ‡å‡†å®šä¹‰äº†ä¸€ç§æ–‡ä»¶æ ¼å¼ï¼Œç”¨äºå­˜å‚¨å¸¦æœ‰é™„å¸¦å…¬é’¥è¯ä¹¦çš„ç§é’¥ï¼Œå¹¶ä½¿ç”¨åŸºäºå¯†ç çš„å¯¹ç§°å¯†é’¥è¿›è¡Œä¿æŠ¤
                        PKCS 13:æ¤­åœ†æ›²çº¿å¯†ç å­¦æ ‡å‡†ã€‚å®ƒæ˜¯ä¸€ç§å…¬é’¥å¯†ç æ–¹æ³•
                    PDFå¼€æºäºAdobeï¼Œè§„èŒƒäºISOï¼Œç›®å‰å·²æœ‰å¤šç§ç±»å‹PDF/X,PDF/A,PDF/E,PDF/VT,PDF/UA
                    ETSIç»„ç»‡å‘å¸ƒäº†é«˜çº§ç”µå­ç­¾åçš„æŠ€æœ¯æ ‡å‡†ï¼šæœ‰3å¥—è§„èŒƒã€‚è¯¥æ ‡å‡†å†…å®¹æŒ‡æ˜ï¼šå”¯ä¸€å…³è”ç­¾åäººï¼Œè¯†åˆ«ç­¾åäººï¼Œç­¾å­—äººå¯ä»¥åœ¨ä»–çš„å”¯ä¸€æ§åˆ¶ä¸‹è¿›è¡Œç»´æŠ¤ï¼Œå¹¶é“¾æ¥åˆ°ä¸ä¹‹ç›¸å…³çš„æ•°æ®ï¼Œä»¥ä¾¿å¯¹æ•°æ®è¿›è¡Œä»»ä½•åç»­æ›´æ”¹å¯æ£€æµ‹ã€‚
                        CMSé«˜çº§ç”µå­ç­¾å(CAdES)ï¼šæ˜¯CMSçš„ä¸€ç»„æ‰©å±•ï¼Œå³ä½¿åº•å±‚åŠ å¯†ç®—æ³•è¢«ç ´åï¼Œç”µå­ç­¾åæ–‡æ¡£ä¹Ÿå¯ä»¥é•¿æœŸæœ‰æ•ˆã€‚
                        XMLé«˜çº§ç”µå­ç­¾å(XAdES)ï¼šæ˜¯XML- dsig11çš„æ‰©å±•ï¼Œitextä¸æ”¯æŒã€‚
                      ğŸŒ¿PDFé«˜çº§ç”µå­ç­¾å(PAdES)ï¼šç”±6ä¸ªéƒ¨åˆ†ç»„æˆã€‚æš‚æ—¶æ”¯æŒiText 5.3.4åŠä»¥ä¸Šç‰ˆæœ¬
            - æ€»ç»“
                ä»ä¼ªé€ pdfæ–‡æ¡£åˆ°å“ˆå¸Œç®—æ³•+åŠ å¯†ä¿æŠ¤PDFæ–‡æ¡£

        ç¬¬2ç« ï¼šPDFåŠæ•°å­—ç­¾å
            - PDFæ ¼å¼çš„æ•°å­—ç­¾å
                é—®ï¼šç­¾åå¤„ç†ç¨‹åºå’Œå­è¿‡æ»¤å™¨ï¼Ÿæ•°å­—ç­¾åæ‰€è¦†ç›–çš„å­—èŠ‚èŒƒå›´ï¼Ÿå¦‚ä½•ç»„æˆç­¾åï¼ŸPDFæ”¯æŒçš„ç®—æ³•ï¼Ÿ
                ç­”ï¼šitexté»˜è®¤ä½¿ç”¨/Adobe.PPKLiteè¿‡æ»¤å™¨ã€‚
                        iText5.3.0ä¹‹å‰çš„ç‰ˆæœ¬ï¼šsetCrypto(PdfSignatureAppearance.WINCER_SIGNED)--ä½¿ç”¨å­è¿‡æ»¤å™¨/adbe.pkcs7.sha1
                                             setCrypto(PdfSignatureAppearance.SELF_SIGNED)--ä½¿ç”¨å­è¿‡æ»¤å™¨/adbe.x509.rsa_sha1
                        iText5.3.0ç‰ˆæœ¬ï¼šé»˜è®¤ä½¿ç”¨åˆ†ç¦»ç­¾åï¼ˆ/adbe.pkcs7.detached æˆ–è€… /ETSI.CAdES.detachedï¼‰
                   å¦‚æœå­è¿‡æ»¤å™¨æ˜¯/ETSI.CAdES.detachedæˆ–è€…/ETSI.RFC3161ï¼Œé‚£ä¹ˆå­—èŠ‚èŒƒå›´è¦†ç›–æ•´ä¸ªæ–‡ä»¶ï¼ŒåŒ…æ‹¬ç­¾åå­—å…¸ï¼Œä½†ä¸åŒ…æ‹¬/Contentså€¼
                   ç†è®ºä¸Šï¼šåŒ…å«å…¬é’¥+æ ‡è®°ä¿¡æ¯çš„è¯ä¹¦ï¼Œç§é’¥ï¼ŒåŸå§‹æ–‡æ¡£ï¼Œå­—èŠ‚èŒƒå›´ã€‚è¿™4ä¸ªç»„æˆäº†ç­¾åæ–‡æ¡£ã€‚å®é™…ç»„æˆpdfæ–‡æ¡£æ—¶ï¼Œåœ¨æ–‡æ¡£çš„ä¸­é—´ç”±è¯ä¹¦å’Œç­¾åæ¶ˆæ¯æ•°å­—æ—¶é—´æˆ³ç»„æˆæ•°å­—ç­¾å
                        ç­¾åç­¾ç½²çš„æ˜¯æ•´ä¸ªæ–‡æ¡£ï¼Œä¸å­˜åœ¨ç­¾ç½²å•ä¸ªé¡µé¢çš„è¯´æ³•
                   PDFæ”¯æŒçš„åŠ å¯†ç®—æ³•ï¼š
                        adbe.pkcs7.sha1ï¼š
                        adbe.x509.rsa_sha1ï¼š
                        adbe.pkcs7.detached, ETSI.CAdES.detached and ETSI.RFC3161ï¼š
            - ä½¿ç”¨iTextè¿›è¡Œæ•°å­—ç­¾åçš„â€œHello Worldâ€
                é—®ï¼šä¸€ä¸ªå‘æ–‡æ¡£æ·»åŠ å¯è§ç­¾åçš„ç®€å•ç¤ºä¾‹ï¼Ÿç®¡ç†å¯ä¿¡åº¦èº«ä»½åˆ—è¡¨ï¼Ÿåœ¨adobereaderä¸­å‘è”ç³»äººåˆ—è¡¨æ·»åŠ è¯ä¹¦ï¼Ÿç­¾ç½²å¤§å‹PDFæ–‡ä»¶ï¼Ÿ
                ç­”ï¼šç­¾åä¸¾ä¾‹ï¼š
                        app.sign(SRC, String.format(DEST, 4), chain, pk, DigestAlgorithms.RIPEMD160,provider.getName(), CryptoStandard.CADES, "Test 4", "Ghent");

                        public void sign(String src, String dest,Certificate[] chain, PrivateKey pk, String digestAlgorithm, String provider, CryptoStandard subfilter, String reason, String location)throws Exception {
                            PdfReader reader = new PdfReader(src);
                            FileOutputStream os = new FileOutputStream(dest);
                            PdfStamper stamper = PdfStamper.createSignature(reader, os, '\0');

                            // Creating the appearance
                            PdfSignatureAppearance appearance = stamper.getSignatureAppearance();
                            appearance.setReason(reason);
                            appearance.setLocation(location);
                            appearance.setVisibleSignature(new Rectangle(36, 748, 144, 780), 1, "sig");

                            // Creating the signature
                            ExternalDigest digest = new BouncyCastleDigest();
                            ExternalSignature signature =new PrivateKeySignature(pk, digestAlgorithm, provider);
                            MakeSignature.signDetached(appearance, digest, signature, chain,null, null, null, 0, subfilter);
                        }
                    å¯é€šè¿‡ç­¾åé¢æ¿ç‚¹å‡»æŒ‰é’®æ·»åŠ å¯ä¿¡ä»»èº«ä»½
                    åˆ«äººå‘é€è¯ä¹¦ç»™æˆ‘ï¼Œæˆ‘å°†å®ƒæ·»åŠ åˆ°ä¿¡ä»»åˆ—è¡¨ï¼š
                        ä»ç§˜é’¥åº“æŠ½å–è¯ä¹¦ï¼škeytool -export -alias myAlias -file xiongjie.crt -keystore myKey.jks -storepass 123456
                    å¯¹å¤§æ–‡ä»¶ç­¾åæ—¶ï¼Œå¯ä»¥å°†æ•°æ®å‰¯æœ¬ä»å†…å­˜è½¬ç§»åˆ°ç¡¬ç›˜è¿›è¡Œç­¾åï¼šPdfStamper stamper = PdfStamper.createSignature(reader, os, '\0', new File(tmp));
            - åˆ›å»ºå’Œç­¾ç½²ç­¾åå­—æ®µğŸŒ¿ğŸŒ¿ğŸŒ¿ğŸŒ¿ğŸŒ¿
                é—®ï¼šä½¿ç”¨adobeacrobatæ·»åŠ ç­¾åå­—æ®µï¼Ÿä½¿ç”¨iTextä»¥ç¼–ç¨‹æ–¹å¼åˆ›å»ºç­¾åå­—æ®µï¼Ÿä½¿ç”¨iTextå°†ç©ºç­¾åå­—æ®µæ·»åŠ åˆ°ç°æœ‰æ–‡æ¡£ï¼Ÿ
                ç­”ï¼šæ‰“å¼€pdfæ–‡æ¡£ï¼Œä»èœå•ä¸­é€‰æ‹©æ·»åŠ æ•°å­—ç­¾åå­—æ®µï¼Œå¹¶åœ¨æ–‡æ¡£ä¸­ç»˜åˆ¶ç­¾ååŒºåŸŸå³å¯ã€‚ç„¶åä½¿ç”¨ä»£ç å¡«å……è¯¥åŒºåŸŸ:appearance.setVisibleSignature(name);
                    åŸç†æ˜¯åˆ›å»ºAcroFormå¯¹è±¡ï¼Œåœ¨å…¶ä¸­è®¾ç½®ä¸€ä¸ªçŸ©å½¢å¹¶è®¾ç½®ä¸€ä¸ªå ä½ç¬¦å±æ€§(æ–‡æœ¬å±æ€§)ã€‚
                    åŒä¸Šä¸€è¡Œ
            - åˆ›å»ºä¸åŒçš„ç­¾åå¤–è§‚
                é—®ï¼šå®šä¹‰è‡ªå®šä¹‰PdfSignatureAppearanceï¼Ÿä½¿ç”¨æ–¹ä¾¿çš„æ–¹æ³•åˆ›å»ºç­¾åå¤–è§‚ï¼Ÿå‘ç­¾åå­—å…¸æ·»åŠ å…ƒæ•°æ®ï¼Ÿæ™®é€šç­¾åå’Œè®¤è¯ç­¾åï¼Ÿåœ¨æ–‡æ¡£ç­¾ç½²åæ·»åŠ å†…å®¹ï¼Ÿ
                ç­”ï¼šæœ‰n0åˆ°n4ä¸ªå›¾å±‚ã€‚
                            PdfTemplate n0 = appearance.getLayer(0);
                            float x = n0.getBoundingBox().getLeft();
                            float y = n0.getBoundingBox().getBottom();
                            float width = n0.getBoundingBox().getWidth();
                            float height = n0.getBoundingBox().getHeight(); n0.setColorFill(BaseColor.LIGHT_GRAY);
                            n0.rectangle(x, y, width, height);
                            n0.fill();

                            PdfTemplate n2 = appearance.getLayer(2);
                            ColumnText ct = new ColumnText(n2);
                            ct.setSimpleColumn(n2.getBoundingBox());
                            Paragraph p = new Paragraph("This document was signed by Bruno Specimen.");
                            ct.addElement(p);
                            ct.go();
                   ç›´æ¥åˆ›å»ºtextå­—æ®µæˆ–è€…imageå­—æ®µï¼Œåˆæˆ–è€…è‡ªå®šä¹‰å‘ˆç°æ¨¡å¼ï¼š
                       appearance.setLayer2Text("This document was signed by Bruno Specimen");
                       appearance.setLayer2Font(new Font(FontFamily.TIMES_ROMAN));

                       appearance.setImage(Image.getInstance(IMG));
                       appearance.setImageScale(-1);

                       RenderingMode.DESCRIPTIONï¼šåªæœ‰æè¿°
                       RenderingMode.NAME_AND_DESCRIPTIONï¼šç­¾åè€…+æè¿°
                       RenderingMode.GRAPHIC_AND_DESCRIPTIONï¼šå›¾åƒ+æè¿°
                       RenderingMode.GRAPHICï¼šå›¾åƒ
                            appearance.setRenderingMode(renderingMode);
                            appearance.setSignatureGraphic(image);
                   å¯ä»¥å°†Nameï¼ŒM,Location,Reason,ContactInfoè¿™äº›åŸæ•°æ®æ·»åŠ åˆ°å­—å…¸
                       PdfSignatureAppearance appearance = stamper.getSignatureAppearance();
                       appearance.setReason(reason);
                       appearance.setLocation(location);
                       appearance.setVisibleSignature(name);
                       appearance.setContact(contact);
                       appearance.setSignDate(signDate);
                       appearance.setSignatureEvent(
                           new SignatureEvent(){
                                   public void getSignatureDictionary(PdfDictionary sig) {
                                   sig.put(PdfName.NAME, new PdfString(fullName));
                                }
                           }
                       );
                   è¯ä¹¦çº§åˆ«ï¼šappearance.setCertificationLevel(certificationLevel);
                        NOT_CERTIFIEDï¼šæ™®é€šç­¾å
                        CERTIFIED_NO_CHANGES_ALLOWEDï¼šè¯ä¹¦ç­¾å--å³ä½œè€…ç­¾åï¼Œç„¶åä¸å‡†ä¿®æ”¹
                        CERTIFIED_FORM_FILLINGï¼šä½œè€…ç­¾ååï¼Œå…¶ä»–äººä¹Ÿå¯ä»¥ç­¾å
                        CERTIFIED_FORM_FILLING_AND_ANNOTATIONSï¼šä½œè€…ç­¾ååï¼Œå…¶ä»–äººä¹Ÿå¯ä»¥ç­¾åå’Œæ·»åŠ æ³¨é‡Š
                   å¯¹ä¸€ä¸ªç­¾åæ–‡æ¡£è¿›è¡Œå¤šæ¬¡ç­¾åï¼ˆä¿è¯ä¹‹å‰çš„ç­¾åæ­£ç¡®ï¼‰ï¼šæ·»åŠ æ³¨é‡Šå’Œæ·»åŠ ç­¾åä¸ç ´ååŸæœ¬å†…å®¹
                        PdfStamper stamper = new PdfStamper(reader, new FileOutputStream(dest), '\0', true); //æ ¸å¿ƒæ˜¯ç¬¬3ï¼Œ4ä¸ªå‚æ•°
            - PDFç­¾åå’Œå·¥ä½œæµ
                é—®ï¼šPDFæ ¼å¼çš„é¡ºåºç­¾åï¼Ÿä¸ºå¤šä¸ªç­¾ååˆ›å»ºå…·æœ‰å ä½ç¬¦çš„è¡¨å•ï¼Ÿå¤šæ¬¡ç­¾ç½²æ–‡æ¡£ï¼Ÿå¤šæ¬¡ç­¾åå’Œå¡«å†™å­—æ®µï¼Ÿç­¾ååé”å®šå­—æ®µå’Œæ–‡æ¡£
                ç­”ï¼šåé¢çš„ç­¾åå¿…é¡»åŒ…å«ç­¾åçš„ç­¾åçš„æ‘˜è¦ï¼Œå¦åˆ™ç­¾åå¤±è´¥
                    ä½¿ç”¨PdfFormFieldåˆ›å»ºå ä½è¡¨å•å­—æ®µ
                    å¤šæ¬¡è°ƒç”¨ç­¾åæ–¹æ³•ï¼Œä¸åŒçš„äººä¸åŒçš„ç­¾åå‚æ•°ã€‚é¡ºåºä¸åŒçš„è¿›è¡Œç­¾åï¼Œå¯èƒ½å¯¹æ–‡æ¡£æœ‰å½±å“
                    é¡ºåºç­¾åçš„å¡«å†™å­—æ®µï¼š
                        AcroFields form = stamper.getAcroFields();
                        form.setField(name, value);
                        form.setFieldProperty(name, "setfflags", PdfFormField.FF_READ_ONLY, null);
                    é”å®šæ“ä½œï¼šè®¤è¯æƒé™å’Œæ‰¹å‡†æƒé™ã€‚
                        ç‰¹å®šçš„é”åŠ¨ä½œï¼šALLï¼ŒINCLUDEï¼ŒEXCLUDEã€‚
                        é”åŠ¨ä½œçš„æƒé™å€¼ï¼šNO_CHANGES_ALLOWEDï¼ŒFORM_FILLINGFORM_FILLING_AND_ANNOTATION
                        PdfSigLockDictionary lock = new PdfSigLockDictionary(LockAction.INCLUDE, "sig1", "approved_bob", "sig2");
                        table.addCell(createSignatureFieldCell(writer, "sig2", lock));
            - æ€»ç»“
                ä»hello,worldç­¾ååˆ°ç­¾åæ˜¾ç¤ºï¼Œåˆ›å»ºç­¾åå­—æ®µå’Œåˆ›å»ºå„ç§å¤–è§‚ï¼Œè®¤è¯ç­¾åå’Œä½œè€…ç­¾åï¼Œå¤šæ¬¡ç­¾åæ“ä½œ

        ç¬¬3ç« ï¼šè¯ä¹¦é¢å‘æœºæ„ã€è¯ä¹¦æ’¤é”€åŠåŠ ç›–æ—¶é—´æˆ³
            - è¯ä¹¦é¢å‘æœºæ„ï¼ˆæ–‡æ¡£æ˜¯ç”¨Cacerté¡¹ç›®cacert.org--ç”¨æˆ·å163é‚®ç®±ï¼Œå¯†ç Xj233550ï¼‰
                é—®ï¼šä»è¯ä¹¦é¢å‘æœºæ„ç”¨p12æ–‡ä»¶ç­¾ç½²æ–‡æ¡£ï¼Ÿä¿¡ä»»è¯ä¹¦é¢å‘æœºæ„çš„æ ¹è¯ä¹¦ï¼Ÿç­¾ç½²åè®®çš„æœ€ä½³å®è·µ
                ç­”ï¼šåœ¨cacert.orgåˆ›å»ºä¸€ä¸ªç§˜é’¥å¯¹ï¼Œç„¶ååœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªå±æ€§æ–‡ä»¶ï¼Œä»æ–‡ä»¶ä¸­è¿›è¡Œç­¾åæ“ä½œ
                    åœ¨cacert.orgä¸‹è½½è¯ä¹¦ï¼Œç„¶ååœ¨é¢æ¿è¿›è¡Œä¿¡ä»»æ“ä½œã€‚å¦‚æœç§é’¥ä¸¢å¤±ï¼Œé€šçŸ¥è¯ä¹¦é¢å‘æœºæ„ï¼Œå°†å…¶åˆ—å…¥æ’¤é”€åˆ—è¡¨ã€‚
                    ç­¾åæ–¹æ³•çš„å‚æ•°è§£é‡Šï¼šMakeSignature.signDetached(appearance, digest, pks, chain, crlList, ocspClient, tsaClient, estimatedSize, subfilter);
            - æ·»åŠ è¯ä¹¦æ’¤é”€ä¿¡æ¯
                é—®ï¼šæŸ¥æ‰¾è¯ä¹¦æ’¤é”€åˆ—è¡¨çš„URLï¼Ÿè·å–CRLçš„URLï¼Ÿä½¿ç”¨CRLçš„ç¦»çº¿å‰¯æœ¬åˆ›å»ºCrlClientï¼Ÿä½¿ç”¨åœ¨çº¿è¯ä¹¦çŠ¶æ€åè®®(OCSP)ï¼Ÿå“ªä¸€ä¸ªæ›´å¥½:åµŒå…¥CRLsè¿˜æ˜¯OCSPå“åº”?
                ç­”ï¼šåœ¨è¯ä¹¦ä¸­åµŒå…¥ä¸€ä¸ªæ’¤é”€åˆ—è¡¨ã€‚ä»£ç ä¸¾ä¾‹ï¼š
                        Certificate[] chain = ks.getCertificateChain(alias);
                        for (int i = 0; i < chain.length; i++) {
                            X509Certificate cert = (X509Certificate)chain[i];
                            System.out.println(String.format("[%s] %s", i, cert.getSubjectDN()));
                            System.out.println(CertificateUtil.getCRLURL(cert));
                        }
                   åœ¨pdfä¸­åµŒå…¥CRLï¼šä½¿ç”¨CrlClientç±»ã€‚æ‰¾åˆ°æ’¤é”€åˆ—è¡¨çš„URLå°±åœæ­¢
                        List<CrlClient> crlList = new ArrayList<CrlClient>();
                        crlList.add(new CrlClientOnline());

                        è®©javaè™šæ‹Ÿæœºä¿¡ä»»Cacerté¢å‘çš„è¯ä¹¦ï¼Œå°†è¯ä¹¦æ·»åŠ åˆ°javaç›®å½•çš„lib/securityä¸­çš„cacertsä¸­
                            keytool -import -keystore cacerts -file CAcertSigningAuthority.crt -alias cacert
                        ä½¿ç”¨ç‰¹å®šçš„URLåˆ›å»ºè¯ä¹¦æ’¤é”€åˆ—è¡¨å®¢æˆ·ç«¯
                            CrlClient crlClient = new CrlClientOnline("https://crl.cacert.org/revoke.crl"); List<CrlClient> crlList = new ArrayList<CrlClient>();
                            crlList.add(crlClient);
                        ä½¿ç”¨ç¦»çº¿å‰¯æœ¬ï¼Œèƒ½å¤ŸèŠ‚çº¦èµ„æºï¼Œé˜²æ­¢æ¯æ¬¡ç­¾åéƒ½å»ä¸‹è½½æ’¤é”€åˆ—è¡¨ã€‚
                   ä»£ç ä¸¾ä¾‹ï¼š
                        FileInputStream is = new FileInputStream(CRL);
                        ByteArrayOutputStream baos = new ByteArrayOutputStream();
                        byte[] buf = new byte[1024];
                        while (is.read(buf) != -1) {
                            baos.write(buf);
                        }
                        CrlClient crlClient = new CrlClientOffline(baos.toByteArray());
                        List<CrlClient> crlList = new ArrayList<CrlClient>();
                        crlList.add(crlClient);


                        CertificateFactory cf = CertificateFactory.getInstance("X.509");
                        X509CRL crl = (X509CRL)cf.generateCRL(new FileInputStream(CRL));
                        System.out.println("CRL valid until: " + crl.getNextUpdate());
                        System.out.println("Certificate revoked: " + crl.isRevoked(chain[0]));
                   èƒ½å¤Ÿè§£å†³åµŒå…¥å¼æ’¤é”€è¯ä¹¦è¿‡å¤§çš„æƒ…å†µï¼š
                        BouncyCastleProvider provider = new BouncyCastleProvider();
                        Security.addProvider(provider);
                        KeyStore ks = KeyStore.getInstance("pkcs12", provider.getName());
                        ks.load(new FileInputStream(path), pass.toCharArray());
                        String alias = (String)ks.aliases().nextElement();
                        Certificate[] chain = ks.getCertificateChain(alias);
                        for (int i = 0; i < chain.length; i++) {
                            X509Certificate cert = (X509Certificate)chain[i];
                            System.out.println(String.format("[%s] %s", i, cert.getSubjectDN()));
                            System.out.println(CertificateUtil.getOCSPURL(cert));
                        }

                        OcspClient ocspClient = new OcspClientBouncyCastle();
                        SignWithOCSP app = new SignWithOCSP();
                        app.sign(pk, chain, SRC, DEST, provider.getName(), "Test", "Ghent",DigestAlgorithms.SHA256, CryptoStandard.CMS, null, ocspClient, null, 0);
                   æœ€å¥½æ˜¯ç»„åˆä½¿ç”¨ã€‚ä¸‰ä¸ªæ–¹é¢çš„è€ƒè™‘å› ç´ ï¼Œå·²ç­¾åæ–‡æ¡£çš„æ–‡ä»¶å¤§å°ã€åˆ›å»ºç­¾åæ—¶çš„æ€§èƒ½å’Œæ³•å¾‹ã€‚æ’¤é”€åˆ—è¡¨å°çš„ä¼˜å…ˆï¼Œæ€§èƒ½å¿«çš„ä¼˜å…ˆã€‚ç¬¦åˆå›½å®¶æ³•å¾‹ï¼Œæ¯”å¦‚å¾·å›½ï¼Œé¢å¤–æ¡ä»¶æ—¶è¯ä¹¦å­˜åœ¨ï¼Œæƒå¨çš„æ—¶é—´æˆ³ç­‰
            - æ·»åŠ æ—¶é—´æˆ³
                é—®ï¼šå¤„ç†è¿‡æœŸå’Œæ’¤é”€æ—¥æœŸï¼Ÿè¿æ¥åˆ°æ—¶é—´æˆ³æœåŠ¡å™¨ï¼Ÿ
                ç­”ï¼šè¦åšåˆ°è¿‡å»ç­¾ç½²çš„æ–‡ä»¶ï¼Œä¸€ç›´åˆ°ä»Šå¤©éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚é€šè¿‡æ·»åŠ æ—¶é—´æˆ³ï¼ŒåŒ…å«å½“æ—¶çš„ç­¾åä¿¡æ¯å’Œæ’¤é”€ä¿¡æ¯ã€‚é€šè¿‡å¦ä¸€ä¸ªç¬¬ä¸‰æ–¹ï¼šæ—¶é—´æˆ³ç®¡ç†å±€(TSA)ã€‚å®ƒå°†è¿”å›ä½¿ç”¨TSAç§é’¥ç­¾åçš„æ•£åˆ—å’Œç»è¿‡èº«ä»½éªŒè¯çš„å±æ€§ã€‚
                    ä»£ç ä¸¾ä¾‹:
                        BouncyCastleProvider provider = new BouncyCastleProvider();
                        Security.addProvider(provider);
                        KeyStore ks = KeyStore.getInstance("pkcs12", provider.getName());
                        ks.load(new FileInputStream(path), pass.toCharArray());
                        String alias = (String)ks.aliases().nextElement();
                        Certificate[] chain = ks.getCertificateChain(alias);
                        for (int i = 0; i < chain.length; i++) {
                            X509Certificate cert = (X509Certificate)chain[i];
                            System.out.println(String.format("[%s] %s", i, cert.getSubjectDN()));
                            System.out.println(CertificateUtil.getTSAURL(cert));
                        }

                        TSAClient tsaClient = new TSAClientBouncyCastle(tsaUrl, tsaUser, tsaPass); //åˆ›å»ºæ—¶é—´æˆ³å¯¹è±¡ï¼ŒæœåŠ¡å™¨æ˜¯GlobalSign

                        TSAClientBouncyCastle tsaClient = new TSAClientBouncyCastle(tsaUrl, tsaUser, tsaPass);
                        tsaClient.setTSAInfo(new TSAInfoBouncyCastle() {
                            public void inspectTimeStampTokenInfo(TimeStampTokenInfo info) {
                                System.out.println(info.getGenTime());
                            }
                        });
            - å¦‚ä½•è·å¾—ç»¿è‰²å‹¾å·
                é—®ï¼šå­˜å‚¨åœ¨å…¶ä»–åœ°æ–¹çš„ä¿¡ä»»è¯ä¹¦ï¼ŸAdobeè®¤å¯ä¿¡æ‰˜åå•(AATL)ï¼Ÿä½¿ç”¨USBä»¤ç‰Œç­¾ç½²æ–‡æ¡£(ç¬¬1éƒ¨åˆ†:MSCAPI)ï¼Ÿ
                ç­”ï¼šå¾ˆå¤šè½¯ä»¶å’Œç¡¬ä»¶é™„å¸¦ä¸€ä¸ªæ ¹å­˜å‚¨ï¼Œå®ƒä»¬åŒ…å«å¸¸è§çš„è¯ä¹¦ã€‚å¯ä»¥åœ¨adobeé…ç½®å®‰å…¨æ—¶è®©å…¶è¯»å–æ“ä½œç³»ç»Ÿè¯ä¹¦
                    å¯ä»¥é€šè¿‡ç½‘ç«™è®¿é—®è¿›è¡Œä¸‹è½½ï¼Œæ›´æ–°æœ¬æœºçš„adobe readerçš„è¯ä¹¦åº“ã€‚CDSæ˜¯ä¸€ä¸ªadobeçš„è®¤è¯æ–‡æ¡£æœåŠ¡
                    ç§˜é’¥å¯¹è¢«å­˜å‚¨åœ¨ç¡¬ä»¶ä¸Šï¼Œä¸èƒ½è¢«æå–ç§é’¥ã€‚åœ¨USBä¸Šå­˜å‚¨è¯ä¹¦ï¼Œæ’å…¥æ“ä½œç³»ç»Ÿåï¼Œè¿›è¡Œè¯ä¹¦æ·»åŠ ã€‚Javaä¸­æœ‰MSCAPIçš„ç­¾åæ¨¡å—ï¼Œåœ¨å¤–éƒ¨è®¾å¤‡ä¸Šå®Œæˆç­¾åï¼Œè€Œä¸æ˜¯javaè™šæ‹Ÿæœºä¸Šã€‚
                        public static void main(String[] args)throws IOException, GeneralSecurityException, DocumentException {
                            LoggerFactory.getInstance().setLogger(new SysoLogger());
                            BouncyCastleProvider providerBC = new BouncyCastleProvider();
                            Security.addProvider(providerBC);

                            SunMSCAPI providerMSCAPI = new SunMSCAPI();
                            Security.addProvider(providerMSCAPI);

                            KeyStore ks = KeyStore.getInstance("Windows-MY");
                            ks.load(null, null);
                            String alias = (String)ks.aliases().nextElement();
                            PrivateKey pk = (PrivateKey)ks.getKey(alias, null);
                            Certificate[] chain = ks.getCertificateChain(alias);

                            OcspClient ocspClient = new OcspClientBouncyCastle();
                            TSAClient tsaClient = null;
                            for (int i = 0; i < chain.length; i++) {
                                X509Certificate cert = (X509Certificate)chain[i];
                                String tsaUrl = CertificateUtil.getTSAURL(cert);
                                if (tsaUrl != null) {
                                    tsaClient = new TSAClientBouncyCastle(tsaUrl);
                                    break;
                                }
                            }
                            List<CrlClient> crlList = new ArrayList<CrlClient>();
                            crlList.add(new CrlClientOnline(chain));
                            SignWithToken app = new SignWithToken();
                            app.sign(SRC, DEST, chain, pk, DigestAlgorithms.SHA256,providerMSCAPI.getName(), CryptoStandard.CMS, "Test", "Ghent", crlList, ocspClient, tsaClient, 0);
                        }
            - ä¼°è®¡ç­¾åå†…å®¹çš„å¤§å°
                ç­”ï¼šitexté¢„ä¼°ç­¾åçš„å¤§å°ã€‚
                        boolean succeeded = false;
                        int estimatedSize = 10300;
                        while (!succeeded) {
                            try {
                                System.out.println("Attempt: " + estimatedSize + " bytes");
                                app.sign(SRC, DEST, chain, pk, DigestAlgorithms.SHA256, provider.getName(),CryptoStandard.CMS, "Test", "Ghent", null, ocspClient, tsaClient,estimatedSize);
                                succeeded = true;
                                System.out.println("Succeeded!");
                            }catch(IOException ioe) {
                                    System.out.println("Not succeeded: " + ioe.getMessage());
                                    estimatedSize += 50;
                            }
                        }
            - æ€»ç»“
                è¯ä¹¦ç»“æ„é¢å‘ç­¾åæ‰€éœ€ã€‚åœ¨pdfä¸­åµŒå…¥è¯ä¹¦æ’¤é”€ä¿¡æ¯--3ç§æ–¹æ³•ã€‚æ—¶é—´æˆ³ä¿è¯ç­¾åæœ‰æ•ˆã€‚ä½¿ç”¨USBä»¤ç‰Œç­¾å

        ç¬¬4ç« ï¼šå¤–éƒ¨åˆ›å»ºç­¾å
            - ä½¿ç”¨PKCS#11ç­¾ç½²æ–‡ä»¶
                é—®ï¼šä½¿ç”¨HSMç­¾ç½²æ–‡æ¡£ï¼Ÿä½¿ç”¨USBä»¤ç‰Œç­¾ç½²æ–‡æ¡£(ç¬¬2éƒ¨åˆ†:PKCS#11)ï¼Ÿä½¿ç”¨æ™ºèƒ½å¡ç­¾ç½²æ–‡ä»¶ï¼Ÿ
                ç­”ï¼šHSMè§£å†³å¤§é‡æ–‡ä»¶çš„æ‰‹å·¥ç­¾ç½²é—®é¢˜ã€‚
                        LoggerFactory.getInstance().setLogger(new SysoLogger()); Properties properties = new Properties();
                        properties.load(new FileInputStream(PROPS));
                        char[] pass = properties.getProperty("PASSWORD").toCharArray();
                        String pkcs11cfg = properties.getProperty("PKCS11CFG");
                        BouncyCastleProvider providerBC = new BouncyCastleProvider();
                        Security.addProvider(providerBC);

                        FileInputStream fis = new FileInputStream(pkcs11cfg);
                        Provider providerPKCS11 = new SunPKCS11(fis);   //æ–°çš„providerè¿›è¡Œç­¾å
                        Security.addProvider(providerPKCS11);

                        KeyStore ks = KeyStore.getInstance("PKCS11");
                        ks.load(null, pass);
                        String alias = (String)ks.aliases().nextElement();
                        PrivateKey pk = (PrivateKey)ks.getKey(alias, pass);
                        Certificate[] chain = ks.getCertificateChain(alias);
                        OcspClient ocspClient = new OcspClientBouncyCastle();
                        TSAClient tsaClient = null;
                        for (int i = 0; i < chain.length; i++) {
                            X509Certificate cert = (X509Certificate)chain[i];
                            String tsaUrl = CertificateUtil.getTSAURL(cert);
                            if (tsaUrl != null) {
                                tsaClient = new TSAClientBouncyCastle(tsaUrl);
                                break;
                            }
                        }
                        List<CrlClient> crlList = new ArrayList<CrlClient>();
                        crlList.add(new CrlClientOnline(chain));
                        SignWithPKCS11HSM app = new SignWithPKCS11HSM();
                        app.sign(SRC, DEST, chain, pk, DigestAlgorithms.SHA256, providerPKCS11.getName(),CryptoStandard.CMS, "HSM test", "Ghent", crlList, ocspClient, tsaClient, 0);
                    USBä»¤ç‰Œç­¾ç½²ï¼Œé…ç½®æ–‡ä»¶å†…å®¹ä¸åŒã€‚å¯ä»¥é€šè¿‡USBä»¤ç‰Œæ¥è·å–æ’æ§½çš„ç´¢å¼•
                        public static final String DLL = "c:/windows/system32/dkck201.dll";
                        String config = "name=ikey4000\n"+ "library=" + DLL + "\n"+ "slotListIndex = " + getSlotsWithTokens(DLL)[0];
                        ByteArrayInputStream bais = new ByteArrayInputStream(config.getBytes());
                        Provider providerPKCS11 = new SunPKCS11(bais);
                        Security.addProvider(providerPKCS11);


                        public static long[] getSlotsWithTokens(String libraryPath) throws IOException{
                            CK_C_INITIALIZE_ARGS initArgs = new CK_C_INITIALIZE_ARGS();
                            String functionList = "C_GetFunctionList";
                            initArgs.flags = 0;
                            PKCS11 tmpPKCS11 = null;
                            long[] slotList = null;
                            try {
                                try {
                                    tmpPKCS11 =PKCS11.getInstance(libraryPath, functionList, initArgs, false);
                                }catch (IOException ex) {
                                    ex.printStackTrace();
                                    throw ex;
                                }
                            }catch (PKCS11Exception e) {
                                try {
                                    initArgs = null;
                                    tmpPKCS11 =PKCS11.getInstance(libraryPath, functionList, initArgs, true);
                                }catch (IOException ex) {
                                    ex.printStackTrace();
                                }catch (PKCS11Exception ex) {
                                 ex.printStackTrace();
                                }
                            }
                            try {
                                slotList = tmpPKCS11.C_GetSlotList(true);
                                for (long slot : slotList){
                                    CK_TOKEN_INFO tokenInfo = tmpPKCS11.C_GetTokenInfo(slot);
                                    System.out.println("slot: "+slot+"\nmanufacturerID: "+ String.valueOf(tokenInfo.manufacturerID) + "\nmodel: " + String.valueOf(tokenInfo.model));
                                }
                            } catch (PKCS11Exception ex) {
                                ex.printStackTrace();
                            }catch (Throwable t) {
                                t.printStackTrace();
                            }
                            return slotList;
                        }
                    æ™ºèƒ½å¡ç­¾ç½²ï¼Œå°±ç±»ä¼¼äºèº«ä»½è¯ä¸€æ ·ã€‚è¯»å¡å™¨è¿æ¥ç”µè„‘ï¼Œè‡ªåŠ¨å‡ºç°è¯ä¹¦ã€‚ä½¿ç”¨æ™ºèƒ½å¡+PKCS#11è¿›è¡Œç­¾åå¦‚ä¸‹ï¼š
                        public static final String DLL = "c:/windows/system32/beidpkcs11.dll";
                        public static void main(String[] args) throws IOException, GeneralSecurityException, DocumentException {
                            LoggerFactory.getInstance().setLogger(new SysoLogger());
                            String config = "name=beid\n" +"library=" + DLL + "\n" +"slotListIndex = " + getSlotsWithTokens(DLL)[0];
                            ByteArrayInputStream bais = new ByteArrayInputStream(config.getBytes());
                            Provider providerPKCS11 = new SunPKCS11(bais);
                            Security.addProvider(providerPKCS11);
                            BouncyCastleProvider providerBC = new BouncyCastleProvider();
                            Security.addProvider(providerBC);
                            KeyStore ks = KeyStore.getInstance("PKCS11");
                            ks.load(null, null);
                            Enumeration<String> aliases = ks.aliases();
                            while (aliases.hasMoreElements()) {
                                System.out.println(aliases.nextElement());
                            }
                            smartcardsign(providerPKCS11.getName(), ks, "Authentication");
                            smartcardsign(providerPKCS11.getName(), ks, "Signature");
                        }

                        public static void smartcardsign(String provider, KeyStore ks, String alias) throws GeneralSecurityException, IOException, DocumentException {
                            PrivateKey pk = (PrivateKey)ks.getKey(alias, null);
                            Certificate[] chain = ks.getCertificateChain(alias);
                            OcspClient ocspClient = new OcspClientBouncyCastle();
                            List<CrlClient> crlList = new ArrayList<CrlClient>();
                            crlList.add(new CrlClientOnline(chain));

                            SignWithPKCS11SC app = new SignWithPKCS11SC();
                            app.sign(SRC, String.format(DEST, alias), chain, pk,DigestAlgorithms.SHA256, provider, CryptoStandard.CMS, "Test", "Ghent", crlList, ocspClient, null, 0);
                        }
            - ä½¿ç”¨javax.smartcardioè°ƒç”¨æ™ºèƒ½å¡ç­¾ç½²æ–‡ä»¶
                é—®ï¼šæ¦‚è¿°javax.smartcardioä¸­æœ€é‡è¦çš„ç±»ï¼Ÿä½¿ç”¨smartcardsignä»Belgian eIDä¸­æå–æ•°æ®ï¼Ÿä¸ºéªŒè¯è€Œå¯¹æ•°æ®è¿›è¡Œç­¾åï¼Ÿä½¿ç”¨Belgian eIDç­¾ç½²æ–‡ä»¶ï¼Ÿ
                ç­”ï¼šTerminalFactoryåˆ›å»ºCardTerminalsï¼ŒåŒ…å«å¤šä¸ªCardTerminalã€‚å¦‚æœåŒ…å«æ™ºèƒ½å¡ï¼Œå¯ä»¥ç»§ç»­åˆ›å»ºCardï¼Œè¿›è€Œconnect()æ–¹æ³•è°ƒç”¨ã€‚
                        ä¹‹ååˆ›å»ºCardChannelï¼Œè°ƒç”¨transmission()å‘é€CommandAPDUæ¶ˆæ¯ï¼Œå¹¶å¾—åˆ°ä¸€ä¸ªResponseAPDU
                    æ¯ä¸ªidå¡åŒ…å«ä¸‰ä¸ªæ•°æ®æ–‡ä»¶ï¼šåœ°å€ï¼Œç…§ç‰‡ï¼Œèº«ä»½æ ‡è¯†ã€‚æ¯ä¸ªå›½å®¶çš„eIdå¡dçš„æ•°æ®æ ¼å¼å¯èƒ½ä¼šæœ‰ä¸åŒ
                        CardReaders readers = new CardReaders();
                        for (CardTerminal terminal : readers.getReaders()) {
                            System.out.println(terminal.getName());
                        }
                        for (CardTerminal terminal : readers.getReadersWithCard()) {
                            System.out.println(terminal.getName());
                            SmartCard card = new SmartCard(terminal);
                            IdentityPojo id = BeIDFileFactory.getIdentity(card);
                            System.out.println(id.toString());
                            AddressPojo address = BeIDFileFactory.getAddress(card);
                            System.out.println(address);
                            PhotoPojo photo = BeIDFileFactory.getPhoto(card);
                            FileOutputStream fos = new FileOutputStream(PHOTO);
                            fos.write(photo.getPhoto());
                            fos.flush();
                            fos.close();
                        }
                    Begian eIDçš„ç¬¬äºŒä¸ªç§˜é’¥å­˜å‚¨åº“ã€‚ç”¨äºä¸å¯å¦è®¤çš„ç­¾å
                        CardReaders readers = new CardReaders();
                        for (CardTerminal terminal : readers.getReadersWithCard()) {
                            SmartCardWithKey card = new SmartCardWithKey(terminal, BeIDCertificates.AUTHENTICATION_KEY_ID, "RSA");
                            card.setPinProvider(new PinDialog(4));  //è‡ªå®šä¹‰å¯¹è¯æ¡†ç±»ï¼Œç´¢è¦pinç 
                            byte[] signed = card.sign("ABCD".getBytes(), "SHA-256");
                            System.out.println(new String(signed));

                            X509Certificate cert =card.readCertificate(BeIDCertificates.AUTHN_CERT_FILE_ID);
                            Cipher cipher = Cipher.getInstance("RSA");
                            cipher.init(Cipher.DECRYPT_MODE, cert.getPublicKey());
                            System.out.println(new String(cipher.doFinal(signed)));
                        }
                    ä»£ç ä¸¾ä¾‹ï¼š
                        CardReaders readers = new CardReaders();
                        SmartCardWithKey card = new BeIDCard(readers.getReadersWithCard().get(0));
                        card.setSecure(true);
                        Certificate[] chain = BeIDCertificates.getSignCertificateChain(card);
                        Collection<CrlClient> crlList = new ArrayList<CrlClient>();
                        crlList.add(new CrlClientOnline(chain));
                        OcspClient ocspClient = new OcspClientBouncyCastle();
                        SignWithBEID app = new SignWithBEID();
                        app.sign(SRC, DEST, card, chain, CryptoStandard.CMS,"Test", "Ghent", crlList, ocspClient, null, 0);


                        public void sign(String src, String dest,SmartCardWithKey card, Certificate[] chain, CryptoStandard subfilter, String reason, String location, Collection<CrlClient> crlList,OcspClient ocspClient, TSAClient tsaClient, int estimatedSize)throws GeneralSecurityException, IOException, DocumentException {
                            PdfReader reader = new PdfReader(src);
                            FileOutputStream os = new FileOutputStream(dest);
                            PdfStamper stamper = PdfStamper.createSignature(reader, os, '\0');

                            PdfSignatureAppearance appearance = stamper.getSignatureAppearance();
                            appearance.setReason(reason);
                            appearance.setLocation(location);
                            appearance.setVisibleSignature(new Rectangle(36, 748, 144, 780), 1, "sig"); // Creating the signature

                            ExternalSignature eid = new EidSignature(card, "SHA256", "BC");
                            ExternalDigest digest = new BouncyCastleDigest();
                            MakeSignature.signDetached(appearance, digest, eid, chain,crlList, ocspClient, tsaClient, estimatedSize, subfilter);
                        }
            - ç”¨äºç­¾åçš„å®¢æˆ·æœº/æœåŠ¡å™¨æ¶æ„
                é—®ï¼šæ„å»ºä¸€ä¸ªç®€å•çš„ç­¾åæœåŠ¡å™¨ï¼Ÿä½¿ç”¨åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºçš„ç­¾ååœ¨å®¢æˆ·æœºä¸Šç­¾åæ–‡æ¡£ï¼Ÿä½¿ç”¨åœ¨å®¢æˆ·æœºä¸Šåˆ›å»ºçš„ç­¾ååœ¨æœåŠ¡å™¨ä¸Šç­¾åæ–‡æ¡£ï¼Ÿé€‰æ‹©æ­£ç¡®çš„æ¶æ„ï¼Ÿ
                ç­”ï¼šweb.xmlé…ç½®ç§˜é’¥å­˜å‚¨åº“ï¼Œå¯†ç ï¼Œç§é’¥å¯†ç ç­‰ä¿¡æ¯ï¼Œåœ¨servletçš„doPost()ä¸­è¿›è¡Œæ–‡æ¡£ç­¾å
                   å®¢æˆ·ç«¯å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨ï¼Œè¿”å›åˆ›å»ºçš„ç­¾åï¼Œç„¶åå°†ç­¾åç­¾ç½²æ–‡æ¡£
                   é¢„ç­¾åâ€”â€”å®¢æˆ·æœºè¯·æ±‚æœåŠ¡å™¨æä¾›æ•£åˆ—ã€‚ç­¾ååâ€”â€”å®¢æˆ·æœºå°†ç­¾ååçš„å­—èŠ‚å‘é€åˆ°æœåŠ¡å™¨ã€‚
                   å…±æœ‰4ç§æ¶æ„ï¼šå•å®¢æˆ·ç«¯ï¼Œå•æœåŠ¡å™¨ç«¯ï¼Œä¸¤ç§æœåŠ¡å™¨-å®¢æˆ·ç«¯æ¨¡å¼
            - æ€»ç»“
                ä½¿ç”¨ç¡¬ä»¶æ¨¡å—åˆ›å»ºç­¾åä½œç”¨äºpdfæ–‡æ¡£ï¼Œäº†è§£æ™ºèƒ½å¡å½¢å¼çš„èº«ä»½è¯ã€‚4ç§å¸¸è§çš„ç­¾åæ¶æ„æ¨¡å¼

        ç¬¬5ç« ï¼šå·²ç­¾ç½²æ–‡ä»¶çš„éªŒè¯
            - æ£€æŸ¥æ–‡ä»¶çš„å®Œæ•´æ€§
                é—®ï¼šåˆ—å‡ºæ–‡æ¡£ä¸­çš„ç­¾åï¼Ÿæ£€æŸ¥ä¿®è®¢çš„å®Œæ•´æ€§ï¼Ÿ
                ç­”ï¼šé€šè¿‡AcroFieldsç±»ä¸­çš„getSignatureNames()æ–¹æ³•ã€‚
                       public void verifySignatures(String path) throws IOException, GeneralSecurityException {
                            System.out.println(path);
                            PdfReader reader = new PdfReader(path);
                            AcroFields fields = reader.getAcroFields();
                            ArrayList<String> names = fields.getSignatureNames();
                            for (String name : names) {
                                System.out.println("===== " + name + " =====");
                                verifySignature(fields, name);
                            }
                            System.out.println();
                       }
                   æ ¸å¿ƒä»£ç ï¼šAcroFields.verifySignature(name)
                       public PdfPKCS7 verifySignature(AcroFields fields, String name) throws GeneralSecurityException, IOException {
                            System.out.println("Signature covers whole document: "+ fields.signatureCoversWholeDocument(name));
                            System.out.println("Document revision: " + fields.getRevision(name) + " of " + fields.getTotalRevisions());
                            PdfPKCS7 pkcs7 = fields.verifySignature(name);
                            System.out.println("Integrity check OK? " + pkcs7.verify());
                            return pkcs7;
                       }
            - ä»ç­¾åä¸­æ£€ç´¢ä¿¡æ¯
                é—®ï¼šç­¾åå­—æ®µå’Œå­—å…¸ä¸­å­˜å‚¨çš„ä¿¡æ¯çš„æ¦‚è¿°ï¼Ÿæ£€æŸ¥ç­¾åï¼Ÿ
                ç­”ï¼šAcroFieldsä¸­è·å–å­—æ®µä¿¡æ¯ï¼ŒPdfPKCS7è·å–ç­¾åä¿¡æ¯
                        public SignaturePermissions inspectSignature(AcroFields fields, String name, SignaturePermissions perms) throws GeneralSecurityException, IOException {
                            List<FieldPosition> fps = fields.getFieldPositions(name);
                            if (fps != null && fps.size() > 0) {
                                FieldPosition fp = fps.get(0);
                                Rectangle pos = fp.position;
                                if (pos.getWidth() == 0 || pos.getHeight() == 0) {
                                    System.out.println("Invisible signature");
                                }
                                else {
                                    System.out.println(String.format("Field on page %s; llx: %s, lly: %s, urx: %s; ury: %s", fp.page,pos.getLeft(), pos.getBottom(), pos.getRight(), pos.getTop()));
                                }
                            }

                            PdfPKCS7 pkcs7 = super.verifySignature(fields, name);
                            System.out.println("Digest algorithm: " + pkcs7.getHashAlgorithm());
                            System.out.println("Encryption algorithm: " + pkcs7.getEncryptionAlgorithm());
                            System.out.println("Filter subtype: " + pkcs7.getFilterSubtype());
                            X509Certificate cert = (X509Certificate) pkcs7.getSigningCertificate();
                            System.out.println("Name of the signer: " +CertificateInfo.getSubjectFields(cert).getField("CN"));

                            if (pkcs7.getSignName() != null){
                                System.out.println("Alternative name of the signer: " + pkcs7.getSignName());
                            }
                            SimpleDateFormat date_format = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss.SS");
                            System.out.println("Signed on: " +date_format.format(pkcs7.getSignDate().getTime()));
                            if (pkcs7.getTimeStampDate() != null) {
                                System.out.println("TimeStamp: " + date_format.format(pkcs7.getTimeStampDate().getTime()));
                                TimeStampToken ts = pkcs7.getTimeStampToken();
                                System.out.println("TimeStamp service: " + ts.getTimeStampInfo().getTsa());
                                System.out.println("TimeStamp verified? "+ pkcs7.verifyTimestampImprint());
                            }
                            System.out.println("Location: " + pkcs7.getLocation());
                            System.out.println("Reason: " + pkcs7.getReason());
                            PdfDictionary sigDict = fields.getSignatureDictionary(name);
                            PdfString contact = sigDict.getAsString(PdfName.CONTACTINFO);

                            if (contact != null){
                                System.out.println("Contact info: " + contact);
                            }
                            perms = new SignaturePermissions(sigDict, perms);
                            System.out.println("Signature type: " +(perms.isCertification() ? "certification" : "approval"));
                            System.out.println("Filling out fields allowed: " +perms.isFillInAllowed());
                            System.out.println("Adding annotations allowed: " +perms.isAnnotationsAllowed());
                            for (FieldLock lock : perms.getFieldLocks()) {
                                System.out.println("Lock: " + lock.toString());
                            }
                            return perms;
                        }
                æŸ¥çœ‹ç­¾åæ˜¯å¦å®Œæ•´ï¼Œæ˜¯å¦æœ‰ä¿®æ”¹ï¼ŒæŸ¥çœ‹æ—¶é—´æˆ³ç­‰å…ƒæ•°æ®ã€‚
            - éªŒè¯ç­¾åçš„è¯ä¹¦
                é—®ï¼šåˆ›å»ºè‡ªå·±çš„æ ¹å­˜å‚¨ï¼Ÿæ ¹æ®å¯†é’¥å­˜å‚¨åº“éªŒè¯ç­¾åï¼Ÿä»è¯ä¹¦ä¸­æå–ä¿¡æ¯ï¼Ÿæ£€æŸ¥ä½¿ç”¨CRLså’ŒOCSPçš„è¯ä¹¦æ˜¯å¦è¢«æ’¤é”€ï¼Ÿ
                ç­”ï¼šJavaä¸­é€šå¸¸ä½¿ç”¨cacertsæ–‡ä»¶ä½œä¸ºæ ¹å­˜å‚¨ã€‚å¾€å­˜å‚¨åº“æ·»åŠ è¯ä¹¦
                        KeyStore ks = KeyStore.getInstance(KeyStore.getDefaultType());
                        ks.load(null, null);
                        CertificateFactory cf = CertificateFactory.getInstance("X.509");
                        ks.setCertificateEntry("cacert",cf.generateCertificate(new FileInputStream(CACERT)));
                        ks.setCertificateEntry("adobe",cf.generateCertificate(new FileInputStream(ADOBE)));
                        ks.setCertificateEntry("bruno",cf.generateCertificate(new FileInputStream(BRUNO)));
                    å­˜åœ¨å¯¹åº”è¯ä¹¦åˆ™æˆåŠŸã€‚æ ¸å¿ƒæ–¹æ³•verifyCertificates()
                        Certificate[] certs = pkcs7.getSignCertificateChain();
                        Calendar cal = pkcs7.getSignDate();
                        List<VerificationException> errors =CertificateVerification.verifyCertificates(certs, ks, cal);
                        if (errors.size() == 0){
                            System.out.println("Certificates verified against the KeyStore");
                        }else{
                            System.out.println(errors);
                        }
                    æ£€æŸ¥è¯ä¹¦æ˜¯å¦ä¾ç„¶æœ‰æ•ˆï¼Œä»ä¸­æŠ½å–ä¿¡æ¯
                        public void showCertificateInfo(X509Certificate cert, Date signDate) {
                            System.out.println("Issuer: " + cert.getIssuerDN());
                            System.out.println("Subject: " + cert.getSubjectDN());
                            SimpleDateFormat date_format = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss.SS");
                            System.out.println("Valid from: " + date_format.format(cert.getNotBefore()));
                            System.out.println("Valid to: " + date_format.format(cert.getNotAfter()));
                            try{
                                cert.checkValidity(signDate);
                                System.out.println("The certificate was valid at the time of signing.");
                            }catch(CertificateExpiredException e) {
                                System.out.println("The certificate was expired at the time of signing.");
                            }catch(CertificateNotYetValidException e) {
                                System.out.println("The certificate wasn't valid yet at the time of signing.");
                            }
                            try {
                                cert.checkValidity();
                                System.out.println("The certificate is still valid.");
                            }catch (CertificateExpiredException e) {
                                System.out.println("The certificate has expired.");
                            }catch (CertificateNotYetValidException e) {
                                System.out.println("The certificate isn't valid yet.");
                            }
                        }
                    æ£€æŸ¥ç­¾åè¯ä¹¦çš„æ’¤é”€çŠ¶æ€ã€‚ä»£ç ä¸¾ä¾‹ï¼š
                        X509Certificate signCert = (X509Certificate)certs[0];
                        X509Certificate issuerCert = (certs.length > 1 ? (X509Certificate)certs[1] : null);
                        System.out.println("=== Checking validity of the document at the time of signing ===");
                        checkRevocation(pkcs7, signCert, issuerCert, cal.getTime());
                        System.out.println("=== Checking validity of the document today ===");
                        checkRevocation(pkcs7, signCert, issuerCert, new Date());

                        //ä½¿ç”¨OCSPéªŒè¯è¯ä¹¦
                        public void checkRevocation(PdfPKCS7 pkcs7,X509Certificate signCert, X509Certificate issuerCert, Date date) throws GeneralSecurityException, IOException {
                            List<BasicOCSPResp> ocsps = new ArrayList<BasicOCSPResp>();
                            if (pkcs7.getOcsp() != null){
                                ocsps.add(pkcs7.getOcsp());
                            }
                            OCSPVerifier ocspVerifier = new OCSPVerifier(null, ocsps);
                            List<VerificationOK> verification =ocspVerifier.verify(signCert, issuerCert, date);
                            if (verification.size() == 0) {
                                List<X509CRL> crls = new ArrayList<X509CRL>();
                                if (pkcs7.getCRLs() != null) {
                                    for (CRL crl : pkcs7.getCRLs())
                                        crls.add((X509CRL)crl);
                                    }
                                CRLVerifier crlVerifier = new CRLVerifier(null, crls);
                                verification.addAll(crlVerifier.verify(signCert, issuerCert, date));
                            }
                            if (verification.size() == 0) {
                                System.out.println("The signing certificate couldn't be verified");
                            }
                            else {
                                for (VerificationOK v : verification){
                                    System.out.println(v);
                                }
                            }
                        }
            - PAdES-4:é•¿æœŸéªŒè¯(LTV)
                é—®ï¼šæ·»åŠ æ–‡æ¡£å®‰å…¨å­˜å‚¨(DSS)å’Œæ–‡æ¡£çº§æ—¶é—´æˆ³ï¼Ÿåˆ›å»ºDSSé€‰æ‹©éœ€è¦æ·»åŠ å“ªäº›éªŒè¯ä¿¡æ¯ï¼Ÿä½¿ç”¨æ–‡æ¡£çº§æ—¶é—´æˆ³æ£€æŸ¥æ–‡æ¡£çš„å®Œæ•´æ€§ï¼ŸéªŒè¯LTVæ–‡æ¡£ï¼Ÿ
                ç­”ï¼šä¿è¯ä»¥å‰çš„ç­¾åæ–‡æ¡£ç°åœ¨æ˜¯æœ‰æ•ˆã€‚ä½¿ç”¨å­è¿‡æ»¤å™¨/ETSI.RFC3161ã€‚æ—¶é—´æˆ³æœ¬èº«æ˜¯è¿›è¿‡ç­¾åçš„ã€‚
                        public void addLtv(String src, String dest, OcspClient ocsp,CrlClient crl, TSAClient tsa)throws IOException, DocumentException, GeneralSecurityException {
                            PdfReader r = new PdfReader(src);
                            FileOutputStream fos = new FileOutputStream(dest);
                            PdfStamper stp = PdfStamper.createSignature(r, fos, '\0', null, true);
                            LtvVerification v = stp.getLtvVerification();
                            AcroFields fields = stp.getAcroFields();
                            List<String> names = fields.getSignatureNames();
                            String sigName = names.get(names.size() - 1);
                            PdfPKCS7 pkcs7 = fields.verifySignature(sigName);

                            if (pkcs7.isTsp()){
                                    v.addVerification(sigName, ocsp, crl,LtvVerification.CertificateOption.SIGNING_CERTIFICATE, LtvVerification.Level.OCSP_CRL, LtvVerification.CertificateInclusion.NO);
                            }else {
                                for (String name : names) {
                                    v.addVerification(name, ocsp, crl, LtvVerification.CertificateOption.WHOLE_CHAIN, LtvVerification.Level.OCSP_CRL, LtvVerification.CertificateInclusion.NO);
                                }
                            }
                            PdfSignatureAppearance sap = stp.getSignatureAppearance();
                            LtvTimestamp.timestamp(sap, tsa, null);
                        }
                   åœ¨è¯ä¹¦æœ€ç»ˆè¿‡æœŸä¹‹æ—¶æ·»åŠ DSSå¾ˆé‡è¦ï¼š
                        SIGNING_CERTIFICATE:å¯¹äºç­¾åè¯ä¹¦æ·»åŠ é¢å¤–éªŒè¯ä¿¡æ¯
                        WHOLE_CHAIN:ä¸ºé“¾ä¸­çš„æ¯ä¸ªè¯ä¹¦æ·»åŠ é¢å¤–çš„éªŒè¯ã€‚
                   æ£€æŸ¥æ–‡æ¡£çº§åˆ«æ—¶é—´æˆ³éœ€è¦TSAClient tsa = new TSAClientBouncyCastle( tsaUrl, tsaUser, tsaPass, 6500, "SHA512");
                   åœ¨ä¸Šä¸€ä¸ªæ—¶é—´æˆ³çš„åŸºç¡€ä¸Šè¿›è¡ŒéªŒè¯ï¼š
                        public void validate(PdfReader reader)throws IOException, GeneralSecurityException {
                            KeyStore ks = KeyStore.getInstance(KeyStore.getDefaultType());
                            ks.load(null, null);
                            CertificateFactory cf = CertificateFactory.getInstance("X.509");
                            ks.setCertificateEntry("adobe",cf.generateCertificate(new FileInputStream(ADOBE)));

                            CertificateVerifier custom = new CertificateVerifier(null) {
                                public List<VerificationOK> verify(X509Certificate signCert, X509Certificate issuerCert, Date signDate) throws GeneralSecurityException, IOException {
                                    System.out.println(signCert.getSubjectDN().getName() +": ALL VERIFICATIONS DONE");
                                    return new ArrayList<VerificationOK>();
                                }
                            };

                            LtvVerifier data = new LtvVerifier(reader);
                            data.setRootStore(ks);
                            data.setCertificateOption(CertificateOption.WHOLE_CHAIN);
                            data.setVerifier(custom);
                            data.setOnlineCheckingAllowed(false);
                            data.setVerifyRootCertificate(false);
                            List<VerificationOK> list = new ArrayList<VerificationOK>();
                            try {
                                data.verify(list);
                            }catch(GeneralSecurityException e) {
                                System.err.println(e.getMessage());
                            }
                            System.out.println();
                            if (list.size() == 0) {
                                System.out.println("The document can't be verified");
                            }
                            for (VerificationOK v : list){
                                System.out.println(v.toString());
                            }
                        }
            - æ€»ç»“
                æ£€æŸ¥ç­¾åæ–‡æ¡£çš„ä¸åŒä¿®è®¢çš„å®Œæ•´æ€§å’Œå…¶ä»–ä¿¡æ¯ã€‚å¤šç§æ–¹æ³•éªŒè¯ç”¨äºç­¾åçš„è¯ä¹¦ã€‚æ–‡æ¡£å®‰å…¨å­˜å‚¨å»¶é•¿æ–‡æ¡£çš„ç”Ÿå‘½å‘¨æœŸ

        é“¾æ¥ï¼š
            è¯ä¹¦é¢å‘æœºæ„ï¼š
                GlobalSign:
                    https://www.globalsign.com/
                    https://www.globalsign.com/pdf-signing/trial.html
                CAcert:
                    https://www.cacert.org



