1.å¼€å§‹å­¦ä¹ Testcontainersè¯­æ³•
    1.ç»¼è¿°ï¼š
        å®˜ç½‘ï¼šhttps://www.testcontainers.org
        å®šä¹‰ï¼šTestcontainersæ˜¯ä¸€ä¸ªæ”¯æŒJUnitæµ‹è¯•çš„Javaåº“ï¼Œå®ƒæä¾›äº†å…¬å…±æ•°æ®åº“ã€Selenium webæµè§ˆå™¨æˆ–ä»»ä½•å…¶ä»–å¯ä»¥åœ¨Dockerå®¹å™¨ä¸­è¿è¡Œçš„è½»é‡çº§ã€ä¸€æ¬¡æ€§å®ä¾‹ã€‚
        ç‰¹ç‚¹ï¼š1.ä½¿æ•°æ®è®¿é—®å±‚é›†æˆæµ‹è¯•æ›´å®¹æ˜“
             2.ä½¿åº”ç”¨é›†æˆæµ‹è¯•æ›´å®¹æ˜“
             3.ä½¿UI/éªŒæ”¶æµ‹è¯•æ›´å®¹æ˜“
        mavenä¾èµ–ï¼š<dependency>
                    <groupId>org.testcontainers</groupId>
                    <artifactId>testcontainers</artifactId>
                    <version>1.11.3</version>
                    <scope>test</scope>
                  </dependency>
    2.å…·ä½“çš„ä»£ç æ¡ˆä¾‹
        2.1 JUnit 4å’ŒTestcontainersçš„ç»„åˆä½¿ç”¨æ•™ç¨‹ï¼š
            1.å‰ææ¡ä»¶ï¼šä¸€ä¸ªä¾èµ–redisçš„é¡¹ç›®ï¼ŒRedisBackedCacheç±»å­˜å‚¨redisæ•°æ®
            2.å¯¼å…¥ä¾èµ–ï¼š<dependency>
                       <groupId>org.testcontainers</groupId>
                       <artifactId>testcontainers</artifactId>
                       <version>1.11.3</version>
                       <scope>test</scope>
                      </dependency>
            3.è®©Testcontainersåœ¨æµ‹è¯•æœŸé—´è¿è¡Œä¸€ä¸ªRediså®¹å™¨
                @Rule
                public GenericContainer redis = new GenericContainer<>("redis:5.0.3-alpine").withExposedPorts(6379);
            4.ç¡®ä¿æˆ‘ä»¬çš„ä»£ç èƒ½å¤Ÿè®¿é—®å®¹å™¨
                setUp(){
                    String address = redis.getContainerIpAddress();
                    Integer port = redis.getFirstMappedPort();

                    RedisBackedCache underTest = new RedisBackedCache(address, port);
                }
            5.è¿è¡Œæµ‹è¯•
                public class RedisBackedCacheIntTest {
                    @Rule
                    public GenericContainer redis = new GenericContainer<>("redis:5.0.3-alpine").withExposedPorts(6379);
                    @Before
                    public void setUp() {
                        String address = redis.getContainerIpAddress();
                        Integer port = redis.getFirstMappedPort();
                        System.out.println(address);
                        System.out.println(port);
                    }
                    @Test
                    public void testSimplePutAndGet() {
                        System.out.println("è®¿é—®dockerå®¹å™¨æµ‹è¯•æˆåŠŸ");
                    }
                }
        2.2 Spockå’ŒTestcontainersçš„ç»„åˆä½¿ç”¨æ•™ç¨‹ï¼š
            å¤§éƒ¨åˆ†å’Œä¸Šé¢ç›¸åŒï¼ŒåŒºåˆ«å¦‚ä¸‹ï¼š
            @org.testcontainers.spock.Testcontainers
            class RedisBackedCacheIntTest extends Specification {
                private RedisBackedCache underTest

                public GenericContainer redis = new GenericContainer<>("redis:5.0.3-alpine").withExposedPorts(6379)

                void setup() {
                    String address = redis.containerIpAddress
                    Integer port = redis.firstMappedPort
                    underTest = new RedisBackedCache(address, port)
                }

                void testSimplePutAndGet() {
                    setup:
                    underTest.put("test", "example")

                    when:
                    String retrieved = underTest.get("test")

                    then:
                    retrieved == "example"
                }
            }
    3.æ•™ç¨‹æ­¥éª¤ï¼š
        3.1 åˆ›å»ºå®¹å™¨
            @ClassRule
            public static GenericContainer alpine =new GenericContainer("alpine:3.2")
                        .withExposedPorts(80)
                        .withEnv("MAGIC_NUMBER", "42")
                        .withCommand("/bin/sh", "-c", "while true; do echo \"$MAGIC_NUMBER\" | nc -l -p 80; done");
            âš ï¸ï¼šä½¿ç”¨@classRuleæ³¨é‡Šçš„ç±»ä¼šåœ¨ä»»æ„æµ‹è¯•å¯åŠ¨ä¹‹å‰æ‰§è¡Œï¼Œå¹¶åœ¨æœ€åè¿›è¡Œé”€æ¯

        3.2 ä¸å®¹å™¨è”ç½‘å’Œé€šä¿¡--æš´éœ²å®¹å™¨ç«¯å£åˆ°ä¸»æœº
            public GenericContainer container = new GenericContainer("orientdb:3.0.13").withExposedPorts(2424, 2480).withLogConsumer(new Slf4jLogConsumer(log));
            Integer firstMappedPort = container.getMappedPort(2424);    //è·å–å¤–ç½‘ç«¯å£
            Integer secondMappedPort = container.getMappedPort(2480);   //è·å–å¤–ç½‘ç«¯å£
            Integer firstMappedPort = container.getFirstMappedPort();   //è¿ç”¨ä¸åªå…¬å¼€ä¸€ä¸ªç«¯å£çš„å®¹å™¨

            String ipAddress = container.getContainerIpAddress();   //è·å–å¤–éƒ¨ä¸»æœºip
            String address =container.getContainerIpAddress() + ":" + container.getMappedPort(2424);

            //å°†æœ¬åœ°ä¸»æœºçš„ç«¯å£æš´éœ²ç»™å®¹å™¨ğŸ‘€ğŸ‘€ğŸ‘€
            Testcontainers.exposeHostPorts(localServerPort);
            final String rootUrl =String.format("http://host.testcontainers.internal:%d/", localServerPort);
            final RemoteWebDriver webDriver = browser.getWebDriver();
            webDriver.get(rootUrl);

            //åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œ
            try (
                Network network = Network.newNetwork();
                GenericContainer foo = new GenericContainer()
                        .withNetwork(network)
                        .withNetworkAliases("foo")
                        .withCommand("/bin/sh", "-c", "while true ; do printf 'HTTP/1.1 200 OK\\n\\nyay' | nc -l -p 8080; done");
                GenericContainer bar = new GenericContainer()
                        .withNetwork(network)
                        .withCommand("top")
            ) {
                foo.start();
                bar.start();
                String response = bar.execInContainer("wget", "-O", "-", "http://foo:8080").getStdout();
                assertEquals("received response", "yay", response);
            }

        3.3 æ‰§è¡Œå‘½ä»¤--å®¹å™¨å¯åŠ¨å‰/ä¸­
            public GenericContainer redisWithCustomPort = new GenericContainer("redis:5.0").withCommand("redis-server --port 7777")
            //è¿è¡Œæ—¶å®¹å™¨æ‰§è¡Œå‘½ä»¤
            container.execInContainer("touch", "/somefile.txt");
            Container.ExecResult lsResult = container.execInContainer("ls", "-al", "/");
            String stdout = lsResult.getStdout();
            int exitCode = lsResult.getExitCode();
            assertTrue(stdout.contains("somefile.txt"));
            assertTrue(exitCode == 0);
            //è®¾ç½®ç¯å¢ƒå˜é‡
            new GenericContainer(...).withEnv("API_TOKEN", "foo")

        3.4 æ–‡ä»¶å’Œvolumes
            new GenericContainer(...).withClasspathResourceMapping("redis.conf","/etc/redis.conf",BindMode.READ_ONLY)

        3.5 å®¹å™¨çš„ç­‰å¾…ç­–ç•¥å’Œå¯åŠ¨ç­–ç•¥
            é»˜è®¤æƒ…å†µä¸‹ï¼ŒTestContainersåœ¨å®¹å™¨ç¬¬ä¸€æ¬¡æ˜ å°„ç½‘ç»œç«¯å£è¿›è¡Œç›‘å¬æ—¶ç­‰å¾…60ç§’
            HTTPçŠ¶æ€ç ç­‰å¾…ç­–ç•¥ï¼š
                public GenericContainer nginxWithHttpWait = new GenericContainer("nginx:1.9.4")
                    .withExposedPorts(80)
                    .waitingFor(Wait.forHttp("/")
                                    .usingTls()
                                    .forStatusCode(200)
                                    .forStatusCode(301)
                                    .forStatusCodeMatching(it -> it >= 200 && it < 300 || it == 401));     //ç±»ä¼¼äºæœåŠ¡çš„æ´»æ€§æ¢é’ˆ
            å¥åº·æ£€æŸ¥ç­‰å¾…ç­–ç•¥ï¼š
                Wait.forHealthcheck()
            æ—¥å¿—è¾“å‡ºç­‰å¾…ç­–ç•¥ï¼š
                public GenericContainer containerWithLogWait = new GenericContainer("redis:5.0.3")
                    .withExposedPorts(6379)
                    .waitingFor(
                        Wait.forLogMessage(".*Ready to accept connections.*\\n", 1)
                    );
        3.6 è®¿é—®å®¹å™¨æ—¥å¿—
            final String logs = container.getLogs();

            Slf4jLogConsumer logConsumer = new Slf4jLogConsumer(LOGGER);
            container.followOutput(logConsumer);

            ToStringConsumer toStringConsumer = new ToStringConsumer();
            container.followOutput(toStringConsumer, OutputType.STDOUT);
            String utf8String = toStringConsumer.toUtf8String();
            String otherString = toStringConsumer.toString(CharSet.forName("ISO-8859-1"));

            WaitingConsumer consumer = new WaitingConsumer();
            container.followOutput(consumer, STDOUT);
            consumer.waitUntil(frame -> frame.getUtf8String().contains("STARTED"), 30, TimeUnit.SECONDS);

            WaitingConsumer waitingConsumer = new WaitingConsumer();
            ToStringConsumer toStringConsumer = new ToStringConsumer();
            Consumer<OutputFrame> composedConsumer = toStringConsumer.andThen(waitingConsumer);
            container.followOutput(composedConsumer);
            waitingConsumer.waitUntil(frame -> frame.getUtf8String().contains("STARTED"), 30, TimeUnit.SECONDS);
            String utf8String = toStringConsumer.toUtf8String();

        3.7 åˆ›å»ºDockerfileå¹¶åˆ›å»ºimage
            ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œæ–‡ä»¶ï¼Œç±»èµ„æºåˆ›å»ºDockerfileï¼š
                @Rule
                public GenericContainer dslContainer = new GenericContainer(
                    new ImageFromDockerfile()
                            .withFileFromString("folder/someFile.txt", "hello")
                            .withFileFromClasspath("test.txt", "mappable-resource/test-resource.txt")
                            .withFileFromClasspath("Dockerfile", "mappable-dockerfile/Dockerfile"))
                new ImageFromDockerfile().withFileFromPath(".", RESOURCE_PATH)
            Dockerfileå®šä¹‰è¯­æ³•ï¼š
                new GenericContainer(new ImageFromDockerfile().withDockerfileFromBuilder(builder ->builder
                                                .from("alpine:3.2")
                                                .run("apk add --update nginx")
                                                .cmd("nginx", "-g", "daemon off;")
                                                .build())
                                    ).withExposedPorts(80);
            âš ï¸ï¼šjvmåˆ é™¤åï¼Œä¸´æ—¶é•œåƒå°†åˆ é™¤ï¼Œé™¤éç»™ä¸´æ—¶é•œåƒä¸€ä¸ªåå­—å’Œä¸€ä¸ªä¸åˆ é™¤çš„æ ‡å¿—
            ä½¿ç”¨æŒ‡å®šçš„Dockerfileåˆ›å»ºé•œåƒï¼š.withDockerfilePath("./Name-Of-Other-Dockerfile").withBuildArg("varname", "value")

        3.8 é«˜çº§é€‰é¡¹
            æ·»åŠ å®¹å™¨æ ‡ç­¾ï¼š
                public GenericContainer containerWithLabel = new GenericContainer("alpine:3.6").withLabel("key", "value");

                private Map<String, String> mapOfLabels = new HashMap<>();
                mapOfLabels.put("key1", "value1");
                public GenericContainer containerWithMultipleLabels = new GenericContainer("alpine:3.6").withLabels(mapOfLabels);
            è‡ªå®šä¹‰å®¹å™¨å±æ€§ï¼š
                @Rule
                public GenericContainer theCache = new GenericContainer<>("redis:3.0.2").withCreateContainerCmdModifier(cmd -> cmd.withHostName("the-cache"));
                @Rule
                public GenericContainer memoryLimitedRedis = new GenericContainer<>("redis:3.0.2")
                        .withCreateContainerCmdModifier(cmd -> cmd.withMemory((long) 8 * 1024 * 1024))
                        .withCreateContainerCmdModifier(cmd -> cmd.withMemorySwap((long) 12 * 1024 * 1024));
    5. æµ‹è¯•æ¡†æ¶é›†æˆ
        5.1 JUnit 4ï¼š
            ä½¿ç”¨@Rule/@ClassRule
                @Rule
                public MySQLContainer mysql = new MySQLContainer();
            ä½¿ç”¨@BeforeClass/@Before/@AfterClass/@After

        5.2 Jupiter /JUnit 5
            ä½¿ç”¨@Testcontainerså’Œ@Container
            @Testcontainers
            class MyTestcontainersTests {
                @Container
                private static final MySQLContainer MY_SQL_CONTAINER = new MySQLContainer();
                @Container
                private PostgreSQLContainer postgresqlContainer = new PostgreSQLContainer()
                        .withDatabaseName("foo")
                        .withUsername("foo")
                        .withPassword("secret");
                @Test
                void test() {
                    assertTrue(MY_SQL_CONTAINER.isRunning());
                    assertTrue(postgresqlContainer.isRunning());
                }
            }
            mavenä¾èµ–ï¼š
                <dependency>
                    <groupId>org.testcontainers</groupId>
                    <artifactId>junit-jupiter</artifactId>
                    <version>1.11.3</version>
                    <scope>test</scope>
                </dependency>

        5.3 Spock
            mavenä¾èµ–ï¼š<dependency>
                        <groupId>org.testcontainers</groupId>
                        <artifactId>spock</artifactId>
                        <version>1.11.3</version>
                        <scope>test</scope>
                    </dependency>
            æµ‹è¯•æ¡ˆä¾‹ï¼š
                @Testcontainers
                class DatabaseTest extends Specification {
                    @Shared
                    PostgreSQLContainer postgreSQLContainer = new PostgreSQLContainer()
                            .withDatabaseName("foo")
                            .withUsername("foo")
                            .withPassword("secret")

                    def "database is accessible"() {

                        given: "a jdbc connection"
                        HikariConfig hikariConfig = new HikariConfig()
                        hikariConfig.setJdbcUrl(postgreSQLContainer.jdbcUrl)
                        hikariConfig.setUsername("foo")
                        hikariConfig.setPassword("secret")
                        HikariDataSource ds = new HikariDataSource(hikariConfig)

                        when: "querying the database"
                        Statement statement = ds.getConnection().createStatement()
                        statement.execute("SELECT 1")
                        ResultSet resultSet = statement.getResultSet()
                        resultSet.next()

                        then: "result is returned"
                        int resultSetInt = resultSet.getInt(1)
                        resultSetInt == 1
                    }
                }

        5.4 æ‰‹åŠ¨å®¹å™¨ç”Ÿå‘½å‘¨æœŸæ§åˆ¶
            try (GenericContainer container = new GenericContainer("imagename")) {
                container.start();
            }
            å•ä¾‹å®¹å™¨ï¼šä½¿ç”¨ç»§æ‰¿
                abstract class AbstractContainerBaseTest {
                    static final MySQLContainer MY_SQL_CONTAINER;
                    static {
                        MY_SQL_CONTAINER = new MySQLContainer();
                        MY_SQL_CONTAINER.start();
                    }
                }
                class FirstTest extends AbstractContainerBaseTest {
                    @Test
                    void someTestMethod() {
                        String url = MY_SQL_CONTAINER.getJdbcUrl();
                    }
                }
    6. ç³»ç»Ÿéœ€æ±‚
        6.1 æ¨èçš„æ—¥å¿—é…ç½®ï¼šlogback-test.xml
            <configuration>
              <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
                  <encoder>
                      <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger - %msg%n</pattern>
                  </encoder>
              </appender>

              <root level="info">
                  <appender-ref ref="STDOUT"/>
              </root>

              <logger name="org.testcontainers" level="INFO"/>
              <logger name="com.github.dockerjava" level="WARN"/>
            </configuration>






























































































































